<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Cream rises to the top.">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Cream rises to the top.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="PD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/RabbitMQ%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/17/RabbitMQ%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/" class="post-title-link" itemprop="url">RabbitMQ快速安装以及与SpringBoot2.x整合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-17 23:19:42" itemprop="dateCreated datePublished" datetime="2021-02-17T23:19:42+08:00">2021-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:22:25" itemprop="dateModified" datetime="2021-02-21T23:22:25+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="快速安装单机版RabbitMQ"><a href="#快速安装单机版RabbitMQ" class="headerlink" title="快速安装单机版RabbitMQ"></a>快速安装单机版RabbitMQ</h2><ul>
<li>准备一台Linux虚拟机（CentOS 7）</li>
<li>进入安装：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 1.首先在Linux上进行一些软件的准备工作，安装一些基础的依赖包</span><br><span class="line">yum install build-essential  openssl openssl-devel unixODBC unixODBC-devel make gcc gcc-c++ kernel-devel</span><br><span class="line"></span><br><span class="line"># 2.下载RabbitMQ所需软件包（这里使用的是RabbitMQ3.6.5稳定版本）</span><br><span class="line">wget https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;releases&#x2F;erlang&#x2F;erlang-18.3-1.el7.centos.x86_64.rpm</span><br><span class="line">wget https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;releases&#x2F;rabbitmq-server&#x2F;v3.6.5&#x2F;rabbitmq-server-3.6.5-1.noarch.rpm</span><br><span class="line"></span><br><span class="line"># 3.安装服务命令</span><br><span class="line">rpm -ivh erlang-18.3-1.el7.centos.x86_64.rpm</span><br><span class="line">rpm -ivh rabbitmq-server-3.6.5-1.noarch.rpm</span><br><span class="line"></span><br><span class="line"># 4.修改用户登录与连接心跳检测</span><br><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;rabbitmq&#x2F;lib&#x2F;rabbitmq_server-3.6.5&#x2F;ebin&#x2F;rabbit.app</span><br><span class="line">修改点1:loopback_users中的&lt;&lt;&quot;guest&quot;&gt;&gt;,只保留guest（用于用户登录）</span><br><span class="line">修改点2:heartbeat 为10（用于心跳连接）</span><br><span class="line"></span><br><span class="line"># 5.安装管理插件和启动服务</span><br><span class="line"></span><br><span class="line"># 5.1 首先启动服务（后面 | 包含了停止、查看状态以及重启的命令）</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;rabbitmq-server start | stop | status | restart</span><br><span class="line"></span><br><span class="line"># 5.2 查看服务有没有启动（5672是RabbitMQ的默认端口）</span><br><span class="line">lsof -i:5672</span><br><span class="line"></span><br><span class="line"># 5.3 安装管理插件</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"></span><br><span class="line"># 5.4 查看管理端口有没有占用</span><br><span class="line">lsof -i:15672  或者  netstat -tunlp | grep 15672</span><br><span class="line"></span><br><span class="line"># 6.访问页面，输入用户名密码均为：guest</span><br><span class="line"># http:&#x2F;&#x2F;你的ip地址:15672&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="RabbitMQ与SpringBoot2-x整合"><a href="#RabbitMQ与SpringBoot2-x整合" class="headerlink" title="RabbitMQ与SpringBoot2.x整合"></a>RabbitMQ与SpringBoot2.x整合</h2><p><strong>聚合工程父pom：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;&#x2F;packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;rabbitmq-consumer&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;rabbitmq-producer&lt;&#x2F;module&gt;</span><br><span class="line">    &lt;&#x2F;modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p><strong>生产者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;rabbitmq-producer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.yml配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8001</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    addresses: 192.168.31.62:5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br><span class="line">    virtual-host: &#x2F;</span><br><span class="line">    connection-timeout: 15000</span><br><span class="line">    publisher-confirms: true    # confirm模式</span><br><span class="line">    publisher-returns: true     # return机制</span><br><span class="line">    template:</span><br><span class="line">      mandatory: true           # 与return机制结合配置次属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：编写RabbitSender生产端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.producer;</span><br><span class="line"></span><br><span class="line">import org.springframework.amqp.core.Message;</span><br><span class="line">import org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate.ConfirmCallback;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate.ReturnCallback;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.lang.Nullable;</span><br><span class="line">import org.springframework.messaging.MessageHeaders;</span><br><span class="line">import org.springframework.messaging.support.MessageBuilder;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RabbitMQSender &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;回调函数，confirm确认</span><br><span class="line">    final ConfirmCallback confirmCallback &#x3D; new ConfirmCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void confirm(@Nullable CorrelationData correlationData, boolean ack, @Nullable String cause) &#123;</span><br><span class="line">            System.out.println(&quot;correlationData: &quot; + correlationData);</span><br><span class="line">            System.out.println(&quot;ack: &quot; + ack);</span><br><span class="line">            if (!ack) &#123;</span><br><span class="line">                System.out.println(&quot;异常处理......&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;回调函数，return返回</span><br><span class="line">    final ReturnCallback returnCallback &#x3D; new ReturnCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) &#123;</span><br><span class="line">            System.out.println(&quot;exchange: &quot; + exchange + &quot;,routingKey: &quot; + routingKey +</span><br><span class="line">                                &quot;,replyCode: &quot; + replyCode + &quot;,replyText: &quot; + replyText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;发送消息方法调用：构建Message消息</span><br><span class="line">    public void send(Object message, Map&lt;String, Object&gt; properties) throws Exception &#123;</span><br><span class="line">        MessageHeaders mhs &#x3D; new MessageHeaders(properties);</span><br><span class="line">        org.springframework.messaging.Message msg &#x3D; MessageBuilder.createMessage(message, mhs);</span><br><span class="line">        rabbitTemplate.setConfirmCallback(confirmCallback);</span><br><span class="line">        rabbitTemplate.setReturnCallback(returnCallback);</span><br><span class="line">        CorrelationData correlationData &#x3D; new CorrelationData(&quot;1234567890&quot;);</span><br><span class="line">        rabbitTemplate.convertAndSend(&quot;exchange-1&quot;, &quot;springboot.abc&quot;, msg, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>消费者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;rabbitmq-consumer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.yml配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    addresses: 192.168.31.62:5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br><span class="line">    virtual-host: &#x2F;</span><br><span class="line">    connection-timeout: 15000</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual    # 手工签收</span><br><span class="line">        concurrency: 5</span><br><span class="line">        max-concurrency: 10</span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：RabbitRecever消费端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.consumer;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line">import org.springframework.amqp.rabbit.annotation.*;</span><br><span class="line">import org.springframework.amqp.support.AmqpHeaders;</span><br><span class="line">import org.springframework.messaging.Message;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RabbitMQReceiver &#123;</span><br><span class="line"></span><br><span class="line">    @RabbitListener(bindings &#x3D; @QueueBinding(</span><br><span class="line">            value &#x3D; @Queue(value &#x3D; &quot;queue-1&quot;,</span><br><span class="line">                           durable&#x3D;&quot;true&quot;),</span><br><span class="line">            exchange &#x3D; @Exchange(value &#x3D; &quot;exchange-1&quot;,</span><br><span class="line">                                 durable&#x3D;&quot;true&quot;,</span><br><span class="line">                                 type&#x3D; &quot;topic&quot;,</span><br><span class="line">                                 ignoreDeclarationExceptions &#x3D; &quot;true&quot;),</span><br><span class="line">            key &#x3D; &quot;springboot.*&quot;</span><br><span class="line">            )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    @RabbitHandler</span><br><span class="line">    public void onMessage(Message message, Channel channel) throws Exception &#123;</span><br><span class="line">        System.err.println(&quot;--------------------------------------&quot;);</span><br><span class="line">        System.err.println(&quot;消费端Payload: &quot; + message.getPayload());</span><br><span class="line">        Long deliveryTag &#x3D; (Long)message.getHeaders().get(AmqpHeaders.DELIVERY_TAG);</span><br><span class="line">        &#x2F;&#x2F;手工ACK</span><br><span class="line">        channel.basicAck(deliveryTag, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>生产端测试：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.test;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.producer.RabbitMQSender;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ApplicationTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitMQSender rabbitMQSender;</span><br><span class="line"></span><br><span class="line">    private static SimpleDateFormat simpleDateFormat &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testSender() throws Exception &#123;</span><br><span class="line">        Map&lt;String, Object&gt; properties &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        properties.put(&quot;number&quot;, &quot;12345&quot;);</span><br><span class="line">        properties.put(&quot;send_time&quot;, simpleDateFormat.format(new Date()));</span><br><span class="line">        rabbitMQSender.send(&quot;Hello RabbitMQ For SpringBoot!&quot;, properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码地址 <a target="_blank" rel="noopener" href="https://github.com/dupeihui/rabbitmq-springboot">https://github.com/dupeihui/rabbitmq-springboot</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/" class="post-title-link" itemprop="url">RabbitMQ中的Confirm确认与Return返回消息</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-17 18:40:25" itemprop="dateCreated datePublished" datetime="2021-02-17T18:40:25+08:00">2021-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:20:57" itemprop="dateModified" datetime="2021-02-21T23:20:57+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Confirm消息确认机制：</strong>  </p>
<ul>
<li>消息的确认是指生产者投递消息后，如果Broker收到消息，则会给我们生产者一个应答。  </li>
<li>生产者进行接受应答，用来确认这条消息是否正常的发送到Broker，这种方式也是消息的可靠性投递的核心保障。</li>
</ul>
<img src="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/confirm.png" class="">

<p><strong>如何实现Confirm确认消息？</strong>  </p>
<ul>
<li>第一步：在channel上开启确认模式：channel.confirmSelect()</li>
<li>第二步：在channel上添加监听：addConfirmListener，监听成功和失败的返回结果，根据具体的结果对消息进行重新发送、或者记录日志等后续处理。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;生产端代码</span><br><span class="line">        &#x2F;&#x2F;1 创建ConnectionFactory</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;2 获取C    onnection</span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;3 通过Connection创建一个新的Channel</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;4 指定我们的消息投递模式: 消息的确认模式</span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_confirm_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;confirm.save&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;5 发送一条消息</span><br><span class="line">        String msg &#x3D; &quot;Hello RabbitMQ Send confirm message!&quot;;</span><br><span class="line">        channel.basicPublish(exchangeName, routingKey, null, msg.getBytes());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;6 添加一个确认监听</span><br><span class="line">        channel.addConfirmListener(new ConfirmListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void handleNack(long deliveryTag, boolean multiple) throws IOException &#123;</span><br><span class="line">                System.err.println(&quot;-------no ack!-----------&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void handleAck(long deliveryTag, boolean multiple) throws IOException &#123;</span><br><span class="line">                System.err.println(&quot;-------ack!-----------&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;消费端代码</span><br><span class="line">        &#x2F;&#x2F;1 创建ConnectionFactory</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;2 获取C    onnection</span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;3 通过Connection创建一个新的Channel</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_confirm_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;confirm.#&quot;;</span><br><span class="line">        String queueName &#x3D; &quot;test_confirm_queue&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;4 声明交换机和队列 然后进行绑定设置, 最后制定路由Key</span><br><span class="line">        channel.exchangeDeclare(exchangeName, &quot;topic&quot;, true);</span><br><span class="line">        channel.queueDeclare(queueName, true, false, false, null);</span><br><span class="line">        channel.queueBind(queueName, exchangeName, routingKey);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;5 创建消费者</span><br><span class="line">        QueueingConsumer queueingConsumer &#x3D; new QueueingConsumer(channel);</span><br><span class="line">        channel.basicConsume(queueName, true, queueingConsumer);</span><br><span class="line"></span><br><span class="line">        while(true)&#123;</span><br><span class="line">            Delivery delivery &#x3D; queueingConsumer.nextDelivery();</span><br><span class="line">            String msg &#x3D; new String(delivery.getBody());</span><br><span class="line"></span><br><span class="line">            System.err.println(&quot;消费端: &quot; + msg);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><strong>Return消息返回机制：</strong>  </p>
<ul>
<li><p>Return Listener用于处理一些不可路由的消息。</p>
</li>
<li><p>我们的消息生产者，通过指定一个Exchange和Routingkey，把消息送到某一个队列中，然后我们的消费者监听队列，进行消息处理操作。但是在某些情况下，如果我们在发送消息的时候，当前的exchange不存在或者指定的路由key路由不到，这个时候我们需要监听这种不可达的消息，就要使用return listener。  </p>
<p><strong>在基础API中有一个关键的配置项：</strong><br><strong>mandatory：</strong> 如果为true，则监听会接收到路由不可达的消息，然后进行后续处理，如果为false，那么broker端自动删除该消息。（默认false）</p>
</li>
</ul>
<img src="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/return.png" class="">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;生产端代码</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchange &#x3D; &quot;test_return_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;return.save&quot;;</span><br><span class="line">        String routingKeyError &#x3D; &quot;abc.save&quot;;</span><br><span class="line"></span><br><span class="line">        String msg &#x3D; &quot;Hello RabbitMQ Return Message&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.addReturnListener(new ReturnListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void handleReturn(int replyCode, String replyText, String exchange,</span><br><span class="line">                    String routingKey, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.err.println(&quot;---------handle  return----------&quot;);</span><br><span class="line">                System.err.println(&quot;replyCode: &quot; + replyCode);</span><br><span class="line">                System.err.println(&quot;replyText: &quot; + replyText);</span><br><span class="line">                System.err.println(&quot;exchange: &quot; + exchange);</span><br><span class="line">                System.err.println(&quot;routingKey: &quot; + routingKey);</span><br><span class="line">                System.err.println(&quot;properties: &quot; + properties);</span><br><span class="line">                System.err.println(&quot;body: &quot; + new String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.basicPublish(exchange, routingKeyError, true, null, msg.getBytes());</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;消费端代码</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_return_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;return.#&quot;;</span><br><span class="line">        String queueName &#x3D; &quot;test_return_queue&quot;;</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(exchangeName, &quot;topic&quot;, true, false, null);</span><br><span class="line">        channel.queueDeclare(queueName, true, false, false, null);</span><br><span class="line">        channel.queueBind(queueName, exchangeName, routingKey);</span><br><span class="line"></span><br><span class="line">        QueueingConsumer queueingConsumer &#x3D; new QueueingConsumer(channel);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queueName, true, queueingConsumer);</span><br><span class="line"></span><br><span class="line">        while(true)&#123;</span><br><span class="line"></span><br><span class="line">            Delivery delivery &#x3D; queueingConsumer.nextDelivery();</span><br><span class="line">            String msg &#x3D; new String(delivery.getBody());</span><br><span class="line">            System.err.println(&quot;消费者: &quot; + msg);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">RabbitMQ入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-13 23:07:05" itemprop="dateCreated datePublished" datetime="2021-02-13T23:07:05+08:00">2021-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:12:47" itemprop="dateModified" datetime="2021-02-21T23:12:47+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是RabbitMQ-？"><a href="#什么是RabbitMQ-？" class="headerlink" title="什么是RabbitMQ ？"></a>什么是RabbitMQ ？</h2><p>RabbitMQ是一个开源的消息代理和队列服务器，用来通过普通协议在完全不同的应用之间共享数据，RabbitMQ是使用Erlang语言编写的，并且RabbitMQ是基于AMQP协议的。  </p>
<h2 id="什么是AMQP高级消息队列协议-？"><a href="#什么是AMQP高级消息队列协议-？" class="headerlink" title="什么是AMQP高级消息队列协议 ？"></a>什么是AMQP高级消息队列协议 ？</h2><p>AMQP：Advanced Message Queuing Protocol.<br>AMQP定义：是具有现代特征的二进制协议。是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。  </p>
<p><strong>AMQP协议模型</strong>  </p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/AMQP.png" class="">

<p><strong>Server</strong> : 又称Broker，接受客户端的连接，实现AMQP实体服务。<br><strong>Connection</strong> : 连接，应用程序与Broker的网络连接。<br><strong>Channel</strong> : 网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道。客户端可建立多个Channel，每个Channel代表一个会话任务。<br><strong>Message</strong> : 消息，服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容。<br><strong>Virtual host</strong> : 虚拟地址，用于进行逻辑隔离，最上层的消息路由。一个Virtual Host里面可以有若干个Exchange和Queue，同一个VirtualHost 里面不能有相同名称的Exchange或Queue。<br><strong>Exchange</strong> : 交换机，接收消息，根据路由键转发消息到绑定的队列。<br><strong>Binding</strong> :  Exchange和Queue之间的虚拟连接，binding中可以包含routing key。<br><strong>Routing key</strong> : 一个路由规则，虚拟机可用它来确定如何路由一个特定消息。<br><strong>Queue</strong> : 也称为Message Queue,消息队列，保存消息并将它们转发给消费者。</p>
<p><strong>RabbitMQ整体架构</strong></p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/RabbitMQ-arch.png" class="">

<h2 id="RabbitMQ核心API"><a href="#RabbitMQ核心API" class="headerlink" title="RabbitMQ核心API"></a>RabbitMQ核心API</h2><p><strong>核心API - Exchange概念</strong><br>Exchange ： 接受消息，并根据路由键转发消息到所绑定的队列。这是RabbitMQ非常重要的概念。  </p>
<ul>
<li><p>Exchange（交换机）本身有很多属性和类型 ：  </p>
</li>
<li><p>Exchange属性 ：  </p>
<ul>
<li>Type ： 交换机类型 direct、topic、fanout、headers</li>
<li>Durability ： 是否需要持久化，默认为true表示持久化</li>
<li>Auto Delete ： 当最后一个绑定到Exchange上的队列删除后，自动删除该Exchange</li>
<li>Internal ： 当前Exchange是否用于RabbitMQ内部使用，默认为False</li>
<li>Arguments ： 扩展参数，用于扩展AMQP协议自制定化使用</li>
</ul>
</li>
<li><p>交换机类型 ：  </p>
<ul>
<li><p>Direct Exchange : 所有发送到Direct Exchange的消息被转发到RouteKey中指定的Queue，如下图所示：</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/direct.png" class="">
</li>
<li><p>Topic Exchange ： 所有发送到Topic Exchange的消息被转发到所有关心RouteKey中指定Topic的Queue上。Exchange将RouteKey和某Topic进行模糊匹配，此时队列需要绑定一个Topic。符号“#”：匹配一个或多个词，例如“Log.#”能够匹配到”log.info.abc”；符号”<em>“：只匹配一个词，例如”log.</em>“只会匹配到”log.error”。如下图所示：</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/topic.png" class="">
</li>
<li><p>Fanout Exchange ： 不处理路由键，只需要简单的将队列绑定到交换机上。发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。Fanout交换机转发消息是最快的，它不会做各种路由匹配。</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/fanout.png" class="">
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/01/redis%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/01/redis%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">redis哨兵机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-01 13:21:40" itemprop="dateCreated datePublished" datetime="2021-01-01T13:21:40+08:00">2021-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:49" itemprop="dateModified" datetime="2021-02-23T21:22:49+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>Redis Sentinel为Redis提供了高可用，这意味着使用Sentinel可以创建部署，该部署可以在无需人工干预的情况下抵抗某些类型的故障，如主从模式下master节点服务器宕机。<br>Redis Sentinel还提供了附带任务，如：监控、通知、为客户端充当配置提供者。<br>这是宏观上Sentinel功能的完整列表：  </p>
<ul>
<li>监控：Sentinel会不断的检查主实例和从实例是否按预期工作。</li>
<li>通知：Sentinel可以通过API通知系统管理员或其他计算机程序，其中一个受监控的Redis实例出了问题。</li>
<li>自动故障转移：如果主服务未按预期工作，则Sentinel可以启动故障转移过程，在该过程中将其中一个从服务升级为主服务，其他从服务重新配置新主服务的地址，使用Redis服务的应用程序在连接时被通知使用新主服务的地址。  </li>
<li>配置提供者：Sentinel充当客户端服务发现的授权来源：客户端连接到Sentinels，以询问负责给定服务的当前Redis主服务的地址。如果发生故障转移，Sentinel将报告新地址。</li>
</ul>
<h2 id="Sentinel配置"><a href="#Sentinel配置" class="headerlink" title="Sentinel配置"></a>Sentinel配置</h2><p>Redis源发行版包含一个名为sentinel.conf的文件，该文件是一个自说明性的示例配置文件，可用于配置Sentinel，但是典型的最小配置文件如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># sentinel monitor &lt;master-group-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</span><br><span class="line"># sentinel监控一个名为mymaster的主服务器，该主服务器地址和端口为127.0.0.1和6379，quorum为触发客观下线的数量</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"># master最长响应时间，超过这个时间就主观判断它下线，默认60秒</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line"></span><br><span class="line"># 执行故障转移的最大等待时间，默认3分钟</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"># 用于限制主从切换之后，最多的并行同步数据的从节点数量</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></table></figure>
<h2 id="运行Sentinel"><a href="#运行Sentinel" class="headerlink" title="运行Sentinel"></a>运行Sentinel</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel &#x2F;path&#x2F;to&#x2F;sentinel.conf</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">redis主从架构模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-29 23:36:34" itemprop="dateCreated datePublished" datetime="2020-12-29T23:36:34+08:00">2020-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:54" itemprop="dateModified" datetime="2021-02-23T21:22:54+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>单机的redis，能够承载的QPS大概在上万到几万不等。对于缓存来说，一般都是用来支撑读高并发。因此架构做成主从（master-slave）架构，一主多从，主负责写，并且将数据复制到其他的slave节点，从节点负责读。所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑读高并发。</p>
<h2 id="redis主从复制的核心原理"><a href="#redis主从复制的核心原理" class="headerlink" title="redis主从复制的核心原理"></a>redis主从复制的核心原理</h2><p>当启动一个slave node的时候，它会发送一个PSYNC命令给master node。<br>如果这是 slave node 初次连接到 master node，那么会触发一次 full resynchronization 全量复制。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后， master 会将这个 RDB 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。  </p>
<img src="/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/redis-master-slave.png" class="">

<h2 id="redis配置主从架构"><a href="#redis配置主从架构" class="headerlink" title="redis配置主从架构"></a>redis配置主从架构</h2><p>进入从节点，打开redis配置文件，进行如下配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 配置所属主服务器ip和端口</span><br><span class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">replicaof 192.168.1.1 6379</span><br><span class="line"></span><br><span class="line"># 配置所属主服务器的密码</span><br><span class="line"># masterauth &lt;master-passord&gt;</span><br><span class="line">masterauth 123456</span><br><span class="line"></span><br><span class="line"># 从服务器通常是只读，配置只读</span><br><span class="line">replica-read-only yes</span><br><span class="line"></span><br><span class="line"># 主从复制同步策略：disk or socket，无磁盘化复制</span><br><span class="line">repl-diskless-sync no</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/13/redis%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/redis%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">redis缓存过期处理与内存淘汰机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 17:17:47" itemprop="dateCreated datePublished" datetime="2020-12-13T17:17:47+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:44" itemprop="dateModified" datetime="2021-02-23T21:22:44+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="已过期的key如何处理"><a href="#已过期的key如何处理" class="headerlink" title="已过期的key如何处理"></a>已过期的key如何处理</h2><p>设置了expire的key缓存过期了，但是服务器的内存还是会被占用，这是因为redis所基于的两种删除策略，redis有两种策略：<br>1.（主动）定时删除  </p>
<ul>
<li>定时随机的检查过期的key，如果过期则清理删除。</li>
</ul>
<p>2.（被动）惰性删除</p>
<ul>
<li>当客户端请求一个已经过期的key的时候，那么redis会检查这个key是否过期了，如果过期了，则删除。这种策略对CPU比较友好，不会有太多的损耗，但是内存占用会比较高。</li>
</ul>
<p>所以，虽然key过期了，但是只要没有被redis清理，那么内存还是会被占用着。</p>
<h2 id="内存淘汰机制"><a href="#内存淘汰机制" class="headerlink" title="内存淘汰机制"></a>内存淘汰机制</h2><p>内存占满了，可以使用磁盘来保存，但是没有意义，因为磁盘没有内存快，会影响redis性能。所以，当内存占用满了以后，redis提供了一套缓存淘汰机制：MEMORY MANAGEMENT</p>
<ul>
<li><p>maxmemory &lt;bytes&gt;<br>  最大可使用内存，超过则开始清理缓存</p>
</li>
<li><p>maxmemory-policy noeviction<br>  volatile-lru  #在那些设置了expire过期时间的key中，使用近似的LRU（Least Recently Used）算法清除key<br>  allkeys-lru  #在所有的key中使用近似的LRU（Least Recently Used）算法清除key<br>  volatile-lfu  #在那些设置了expire过期时间的key中，使用近似的LFU（Least Frequently Used）算法清除key<br>  allkeys-lfu  #在所有的key中使用近似的LFU（Least Frequently Used）算法清除key<br>  volatile-random  #在那些设置了expire过期时间的key中，随机清除key<br>  allkeys-random  #在所有的key中随机清除key<br>  volatile-ttl  #在那些设置了expire过期时间的key中，删除即将过期的<br>  noeviction  #缓存中的key永不删除，返回错误</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/13/Redis%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/Redis%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Redis的两种持久化机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 13:44:13" itemprop="dateCreated datePublished" datetime="2020-12-13T13:44:13+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:19" itemprop="dateModified" datetime="2021-02-23T21:22:19+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>RDB : Redis DataBase</strong><br><strong>AOF : Append Only File</strong></p>
<h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><h3 id="什么是RDB"><a href="#什么是RDB" class="headerlink" title="什么是RDB"></a>什么是RDB</h3><p>RDB：每隔一段时间，把内存中的数据写入磁盘的临时文件，作为快照，恢复的时候把快照文件读进内存。如果宕机重启，那么内存里的数据肯定会没有的，再次重启redis后，则会恢复。</p>
<h3 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h3><p>内存备份–&gt;磁盘临时文件<br>临时文件–&gt;恢复到内存</p>
<h3 id="RDB优劣势"><a href="#RDB优劣势" class="headerlink" title="RDB优劣势"></a>RDB优劣势</h3><ul>
<li><p>优势<br>  1.每个一段时间备份，全量备份<br>  2.灾备简单，可以远程传输<br>  3.子进程备份的时候，主进程不会有任何io操作（不会有写入修改或删除），保证备份数据的完整性<br>  4.相对AOF来说，当有更大文件的时候可以快速重启恢复</p>
</li>
<li><p>劣势<br>  1.发生故障时，有可能会丢失最后一次的备份数据<br>  2.子进程所占用的内存比会和父进程一模一样，如会造成CPU负担<br>  3.由于定时全量备份是重量级操作，所以对于实时备份，就无法处理了</p>
</li>
</ul>
<h3 id="RDB的配置"><a href="#RDB的配置" class="headerlink" title="RDB的配置"></a>RDB的配置</h3><ul>
<li><p>rdb文件保存位置，可以在redis.conf自定义：<br>  /user/local/redis/working/dump.rdb</p>
</li>
<li><p>默认保存机制：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line"># In the example below the behaviour will be to save:</span><br><span class="line"># after 900 sec (15 min) if at least 1 key changed</span><br><span class="line"># after 300 sec (5 min) if at least 10 keys changed</span><br><span class="line"># after 60 sec if at least 10000 keys changed   </span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure></li>
<li><p>stop-writes-on-bgsave-error<br>  yes : 如果save过程出错，则停止写操作<br>  no : 可能造成数据不一致</p>
</li>
<li><p>rdbcompression<br>  yes : 开启rdb压缩模式<br>  no : 关闭，会节约cpu损耗，但是文件会大</p>
</li>
<li><p>rdbchecksum<br>  yes : 使用CRC64算法校验对rdb进行数据校验，有10%的性能损耗<br>  no : 不校验</p>
</li>
</ul>
<p><strong>总结</strong><br>RDB适合大量数据的恢复，但是数据的完整性和一致性可能会不足</p>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><h3 id="什么是AOF"><a href="#什么是AOF" class="headerlink" title="什么是AOF"></a>什么是AOF</h3><p>AOF：以日志的形式来记录用户请求的写操作。读操作不会记录，因为写操作才会存储。文件以追加的形式而不是修改方式。redis的AOF恢复其实就是把追加的文件从开始到结尾读取执行写操作。</p>
<h3 id="AOF的优劣势"><a href="#AOF的优劣势" class="headerlink" title="AOF的优劣势"></a>AOF的优劣势</h3><ul>
<li><p>优势<br>  1.AOF更加耐用，可以以秒级别为单位备份，如果发生问题，也只会丢失最后一秒的数据，大大增加了可靠性和数据完整性。所以AOF可以每秒备份一次，使用fsync操作。<br>  2.以log日志形式追加，如果磁盘满了，会执行redis-check-aof工具。<br>  3.当数据太大的时候，redis可以在后台自动重写aof。当redis继续把日志追加到老的文件中去时，重写也是非常非常安全的，不会影响客户端的读写操作。<br>  4.AOF日志包含所有写操作，会更加便于redis的解析恢复。</p>
</li>
<li><p>劣势<br>  1.相同的数据，同一份数据，AOF比RDB大<br>  2.针对不同的同步机制，AOF会比RDB慢，因为AOF每秒都会备份写操作，这样相对于RDB来说同步略慢。每秒备份fsync没毛病，但是如果客户端的每次写入就做一次备份fsync的话，那么redis的性能就会下降。<br>  3.AOF发生过罕见的bug，就是数据恢复的时候数据不完整，这样显得AOF会比较脆弱，容易出现bug，因为AOF没有RDB那么简单，但是为了防止bug的产生，AOF就不会根据旧的指令去重构，而是根据当时缓存中存在的数据指令去做重构，这样就更加健壮和可靠了。</p>
</li>
</ul>
<h3 id="AOF的配置"><a href="#AOF的配置" class="headerlink" title="AOF的配置"></a>AOF的配置</h3><ul>
<li><p>appendonly no<br>  AOF默认关闭，yes可以开启</p>
</li>
<li><p>appendfilename “appendonly.aof”<br>  AOF文件名</p>
</li>
<li><p>appendfsync everysec<br>  no : 不同步<br>  everysec : 每秒备份，推荐使用<br>  always : 每次操作都会备份，安全并且数据完整，但是性能差</p>
</li>
<li><p>no-appendfsync-on-rewrite no<br>  重写的时候是否要同步，no可以保证数据安全</p>
</li>
<li><p>auto-aof-rewrite-percentage 100</p>
</li>
<li><p>auto-aof-rewrite-min-size 64mb<br>  重写机制：避免文件越来越大，自动优化压缩指令，会fork一个新的进程去完成重写动作，新进程里的内存数据会被重写，此时旧的aof文件不会被读取使用，类似rdb<br>  当前AOF文件的大小是上次AOF文件大小的100%，并且文件体积达到64m，满足两者则触发重写</p>
</li>
</ul>
<p><strong>到底采用RDB还是AOF呢？</strong><br>1.如果你能接受一段时间的缓存丢失，那么可以使用RDB<br>2.如果你对实时性的数据比较关心，那么就使用AOF<br>3.使用RDB和AOF结合一起做持久化，RDB做冷备，可以在不同时期对不同版本做恢复，AOF做热备，保证数据仅仅有1秒的损失。当AOF破损不可用时，那么再用RDB恢复，这样就做到两者的相互结合，也就是说redis恢复会先加载AOF，如果AOF有问题会再加载RDB，这样就达到冷热备份的目的了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/06/Nginx%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/06/Nginx%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">Nginx解决跨域问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-06 22:40:45" itemprop="dateCreated datePublished" datetime="2020-12-06T22:40:45+08:00">2020-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:21:34" itemprop="dateModified" datetime="2021-02-23T21:21:34+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前后端在联调的时候经常会出现跨域问题，这是因为<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">浏览器的同源策略</a>：</p>
<p><strong>什么是跨域？</strong></p>
<blockquote>
<p>浏览器从一个域名的网页去请求另一个域名的资源时，协议、主机、端口任一不同，都是跨域。</p>
</blockquote>
<p>下表给出了与URL<code>http://store.company.com/dir/page.html</code>的源进行比对的示例：</p>
<table>
<thead>
<tr>
<th align="left">URL</th>
<th align="left">结果</th>
<th align="left">原因</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>http://store.company.com/dir2/other.html</code></td>
<td align="left">同源</td>
<td align="left">只有路径不同</td>
</tr>
<tr>
<td align="left"><code>http://store.company.com/dir/inner/another.html</code></td>
<td align="left">同源</td>
<td align="left">只有路径不同</td>
</tr>
<tr>
<td align="left"><code>https://store.company.com/secure.html</code></td>
<td align="left">失败</td>
<td align="left">协议不同</td>
</tr>
<tr>
<td align="left"><code>http://store.company.com:81/dir/etc.html</code></td>
<td align="left">失败</td>
<td align="left">端口不同（<code>http://</code>默认端口是80）</td>
</tr>
<tr>
<td align="left"><code>http://news.company.com/dir/other.html</code></td>
<td align="left">失败</td>
<td align="left">主机不同</td>
</tr>
</tbody></table>
<p>这里我通过nginx部署前端代码，前端代码存放在linux机目录/home/foodie-shop：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       8080;</span><br><span class="line">        server_name  192.168.2.247;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;home&#x2F;foodie-shop;</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端代码通过tomcat部署，再通过nginx反向代理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#配置上游服务器</span><br><span class="line">upstream tomcats &#123;</span><br><span class="line">        server 192.168.2.247:8088;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen  88;</span><br><span class="line">        server_name     192.168.2.247;</span><br><span class="line"></span><br><span class="line">        location ~ &#123;</span><br><span class="line">                proxy_pass      http:&#x2F;&#x2F;tomcats;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>后端接口服务通过nginx配置解决跨域问题</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#配置上游服务器</span><br><span class="line">upstream tomcats &#123;</span><br><span class="line">        server 192.168.2.247:8088;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen  88;</span><br><span class="line">        server_name     192.168.2.247;</span><br><span class="line"></span><br><span class="line">        #允许跨域请求的域,*代表所有</span><br><span class="line">        #add_header &#39;Access-Control-Allow-Origin&#39; *;</span><br><span class="line">        #允许带上cookie请求</span><br><span class="line">        add_header &#39;Access-Control-Allow-Credential&#39; &#39;true&#39;;</span><br><span class="line">        #允许请求的方法，比如GET&#x2F;POST&#x2F;PUT&#x2F;DELETE</span><br><span class="line">        add_header &#39;Access-Control-Allow-Methods&#39; *;</span><br><span class="line">        #允许请求的header</span><br><span class="line">        add_header &#39;Access-Control_Allow-Headers&#39; *;</span><br><span class="line"></span><br><span class="line">        location ~ &#123;</span><br><span class="line">                proxy_pass      http:&#x2F;&#x2F;tomcats;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/05/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/05/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">nginx负载均衡算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-05 21:38:14" itemprop="dateCreated datePublished" datetime="2020-12-05T21:38:14+08:00">2020-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:21:26" itemprop="dateModified" datetime="2021-02-23T21:21:26+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>1、round-robin（默认）</strong><br>轮训方式，依次将请求分配到各个后台服务器，默认的负载均衡方式。适用于后台机器性能一致的情况。挂掉的服务自动从服务列表剔出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 192.168.2.191:8080;</span><br><span class="line">    server 192.168.2.230:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、weight</strong><br>根据权重分发请求到不同机器，weight的值越大，服务器分配的请求越多，主要用于后端每台服务器性能不均衡的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 192.168.2.191:8080 weigth&#x3D;1;</span><br><span class="line">    server 192.168.2.230:8080 weight&#x3D;2;</span><br><span class="line">    server 192.168.2.237:8080 weight&#x3D;3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3、ip_hash</strong><br>每个请求按访问IP的哈希结果分配，使来自同一个IP的访客固定访问一台后端服务器，并且可以有效解决动态网页存在的session共享问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.2.191:8080;</span><br><span class="line">    server 192.168.2.230:8080;</span><br><span class="line">    server 192.168.2.237:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4、url_hash</strong><br>按访问的URL的哈希结果来分配请求，使每个URL定向到一台后端服务器，可以进一步提高后端缓存服务器的效率。Nginx本身不支持url_hash，如果需要这种调度算法，则必须安装Nginx的hash软件包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">    server 192.168.2.191:8080;</span><br><span class="line">    server 192.168.2.230:8080;</span><br><span class="line">    server 192.168.2.237:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5、least_conn</strong><br>将请求分配给连接数最少的服务器，同时考虑服务器的权重，如果有多个这样的服务器，则依次适用加权轮训负载平衡方法进行尝试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server 192.168.2.191:8080 weigth&#x3D;1;</span><br><span class="line">    server 192.168.2.230:8080 weigth&#x3D;2;</span><br><span class="line">    server 192.168.2.237:8080 weigth&#x3D;3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>6、fair</strong><br>比weight、ip_hash更智能的负载均衡算法，fair算法可以根据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身不支持fair，如果需要这种调度算法，则必须安装upsteram_fair模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">    server 192.168.2.191:8080;</span><br><span class="line">    server 192.168.2.230:8080;</span><br><span class="line">    server 192.168.2.237:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/05/nginx%E6%A8%A1%E5%9D%97%EF%BC%9Angx-stream-upstream-module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/05/nginx%E6%A8%A1%E5%9D%97%EF%BC%9Angx-stream-upstream-module/" class="post-title-link" itemprop="url">nginx模块：ngx_stream_upstream_module</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-05 17:34:28" itemprop="dateCreated datePublished" datetime="2020-12-05T17:34:28+08:00">2020-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:21:40" itemprop="dateModified" datetime="2021-02-23T21:21:40+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>官方介绍</strong>：<br>The <code>ngx_stream_upstream_module</code> module (1.9.0) is used to define groups of servers that can be referenced by the proxy_pass directive.  </p>
<p><strong>Example Configuration</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    hash $remote_addr consistent;</span><br><span class="line"></span><br><span class="line">    server backend1.example.com:12345  weight&#x3D;5;</span><br><span class="line">    server backend2.example.com:12345;</span><br><span class="line">    server unix:&#x2F;tmp&#x2F;backend3;</span><br><span class="line"></span><br><span class="line">    server backup1.example.com:12345   backup;</span><br><span class="line">    server backup2.example.com:12345   backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 12346;</span><br><span class="line">    proxy_pass backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Directives</strong></p>
<blockquote>
<p>Syntax:    upstream name { … }<br>Default:    —<br>Context:    stream</p>
</blockquote>
<p>Defines a group of servers. Servers can listen on different ports. In addition, servers listening on TCP and UNIX-domain sockets can be mixed.<br>Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com:12345 weight&#x3D;5;</span><br><span class="line">    server 127.0.0.1:12345            max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">    server unix:&#x2F;tmp&#x2F;backend2;</span><br><span class="line">    server backend3.example.com:12345 resolve;</span><br><span class="line"></span><br><span class="line">    server backup1.example.com:12345  backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>By default, connections are distributed between the servers using a weighted round-robin balancing method. In the above example, each 7 connections will be distributed as follows: 5 connections go to <code>backend1.example.com:12345</code> and one connection to each of the second and third servers. If an error occurs during communication with a server, the connection will be passed to the next server, and so on until all of the functioning servers will be tried. If communication with all servers fails, the connection will be closed.</p>
<blockquote>
<p>Syntax:    server address [parameters];<br>Default:    —<br>Context:    upstream</p>
</blockquote>
<p>Defines the <code>address</code> and other <code>parameters</code> of a server. The address can be specified as a domain name or IP address with an obligatory port, or as a UNIX-domain socket path specified after the “unix:” prefix. A domain name that resolves to several IP addresses defines multiple servers at once.</p>
<p>The following parameters can be defined:  </p>
<p><code>weight=number</code><br>sets the weight of the server, by default, 1.</p>
<p><code>max_conns=number</code><br>limits the maximum number of simultaneous connections to the proxied server (1.11.5). Default value is zero, meaning there is no limit. If the server group does not reside in the shared memory, the limitation works per each worker process.  </p>
<blockquote>
<p>限制每台server的连接数，用于保护避免过载，可起到限流作用。</p>
</blockquote>
<p><code>max_fails=number</code><br>sets the number of unsuccessful attempts to communicate with the server that should happen in the duration set by the <code>fail_timeout</code> parameter to consider the server unavailable for a duration also set by the <code>fail_timeout</code> parameter. By default, the number of unsuccessful attempts is set to 1. The zero value disables the accounting of attempts. Here, an unsuccessful attempt is an error or timeout while establishing a connection with the server.  </p>
<p><code>fail_timeout=time</code>  </p>
<ul>
<li>the time during which the specified number of unsuccessful attempts to communicate with the server should happen to consider the server unavailable;</li>
<li>and the period of time the server will be considered unavailable.  </li>
</ul>
<p>By default, the parameter is set to 10 seconds.</p>
<blockquote>
<p>max_fails:表示失败几次，则标记server已宕机，剔出上游服务器。<br>fail_timeout:表示失败的重试时间。<br>假设目前设置如下：<br>max_fails=2 fail_timeout=15s<br>则代表在15秒内请求某一server失败达到2次，则认为该server已经挂了或宕机了，随后再过15秒，这15秒内不会有新的请求到达刚刚挂掉的节点上，而是会请求正在运行的server，15秒后会再有新请求尝试连接挂掉的server，如果还是失败，重复上一过程，直到恢复。</p>
</blockquote>
<p><code>backup</code>  </p>
<ul>
<li>marks the server as a backup server. Connections to the backup server will be passed when the primary servers are unavailable.</li>
<li>The parameter cannot be used along with the hash and random load balancing methods.</li>
</ul>
<blockquote>
<p>backup表示当前服务器节点是备用机，只有在其他的服务器都宕机以后， 自己才会加入到集群中，被用户访问到。</p>
</blockquote>
<p><code>down</code><br>marks the server as permanently unavailable.</p>
<blockquote>
<p>down用于标记服务节点不可用。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">PD</p>
  <div class="site-description" itemprop="description">Cream rises to the top.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PD</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
