<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Cream rises to the top.">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Cream rises to the top.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="PD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/%E5%9F%BA%E4%BA%8EZookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/%E5%9F%BA%E4%BA%8EZookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">基于Zookeeper实现分布式锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-20 23:50:40" itemprop="dateCreated datePublished" datetime="2021-02-20T23:50:40+08:00">2021-02-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:23:33" itemprop="dateModified" datetime="2021-02-23T21:23:33+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基于Zookeeper的瞬时有序节点实现分布式锁"><a href="#基于Zookeeper的瞬时有序节点实现分布式锁" class="headerlink" title="基于Zookeeper的瞬时有序节点实现分布式锁"></a>基于Zookeeper的瞬时有序节点实现分布式锁</h2><h3 id="Zookeeper基本概念"><a href="#Zookeeper基本概念" class="headerlink" title="Zookeeper基本概念"></a>Zookeeper基本概念</h3><p>Zookeeper存储数据的结构是一棵树</p>
<ul>
<li><p>1.分为持久节点和瞬间节点</p>
</li>
<li><p>2.持久节点就是你的会话结束或者Zookeeper重启，这些节点不会消失，除非你手动删除这些节点</p>
</li>
<li><p>3.瞬间节点（有序），连接Zookeeper的会话断了或者Zookeeper重启，那么瞬时节点会消失。瞬时节点不可拥有子节点。有序是指创建节点的时候，节点名称是按照序号排序的，这点非常重要</p>
</li>
<li><p>4.Zookeeper另外一个非常重要的概念，就是观察器，它可以检查Zookeeper中某个节点的变化，如果节点发生变化，它会立刻通知到客户端，客户端根据变化进行操作，Zookeeper的观察器可以检查三个方法：getData();getChildren();exists()。观察器只能监听一次，如果你要再次监控这个节点的话，需要重新设置这个观察器，这是Zookeeper的一个特点</p>
</li>
</ul>
<img src="/2021/02/20/%E5%9F%BA%E4%BA%8EZookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/zk-structure.png" class="">

<h3 id="Zookeeper分布式锁的实现原理"><a href="#Zookeeper分布式锁的实现原理" class="headerlink" title="Zookeeper分布式锁的实现原理"></a>Zookeeper分布式锁的实现原理</h3><ul>
<li><p>利用Zookeeper的瞬间有序节点的特性</p>
</li>
<li><p>多线程并发创建瞬时节点时，得到有序的序列</p>
</li>
<li><p>序号最小的线程获得锁</p>
</li>
<li><p>其他的线程则监听自己序号的前一个序号</p>
</li>
<li><p>前一个线程执行完成，删除自己序号的节点</p>
</li>
<li><p>下一个序号的线程得到通知，继续执行</p>
</li>
</ul>
<img src="/2021/02/20/%E5%9F%BA%E4%BA%8EZookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/zk-distribute-lock.png" class="">

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>引入zk的maven依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.zookeeper&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;zookeeper&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.6.2&lt;&#x2F;version&gt;    </span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>zk加锁解锁是实现类ZkLock.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.lock;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.zookeeper.*;</span><br><span class="line">import org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class ZkLock implements Watcher,AutoCloseable &#123;</span><br><span class="line"></span><br><span class="line">    private ZooKeeper zooKeeper;</span><br><span class="line">    private String businessName;</span><br><span class="line">    private String znode;</span><br><span class="line"></span><br><span class="line">    public ZkLock(String connectString, String businessName) throws IOException &#123;</span><br><span class="line">        this.zooKeeper &#x3D; new ZooKeeper(connectString, 30000, this);</span><br><span class="line">        this.businessName &#x3D; businessName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获得分布式锁</span><br><span class="line">     * @return</span><br><span class="line">     * @throws KeeperException</span><br><span class="line">     * @throws InterruptedException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean getLock() throws KeeperException, InterruptedException &#123;</span><br><span class="line">        &#x2F;&#x2F;创建业务根节点</span><br><span class="line">        Stat stat &#x3D; zooKeeper.exists(&quot;&#x2F;&quot; + businessName, false);</span><br><span class="line">        if (stat &#x3D;&#x3D; null) &#123;</span><br><span class="line">            zooKeeper.create(&quot;&#x2F;&quot; + businessName, businessName.getBytes(),</span><br><span class="line">                    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建瞬时有序节点，&#x2F;order&#x2F;order_0000000001</span><br><span class="line">        znode &#x3D; zooKeeper.create(&quot;&#x2F;&quot; + businessName + &quot;&#x2F;&quot; + businessName + &quot;_&quot;, businessName.getBytes(),</span><br><span class="line">                ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        znode &#x3D; znode.substring(znode.lastIndexOf(&quot;&#x2F;&quot;)+1);</span><br><span class="line">        log.info(&quot;瞬时有序节点：&quot; + znode);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; childrenNodes &#x3D; zooKeeper.getChildren(&quot;&#x2F;&quot; + businessName, false);</span><br><span class="line">        Collections.sort(childrenNodes);</span><br><span class="line"></span><br><span class="line">        String firstNode &#x3D; childrenNodes.get(0);</span><br><span class="line">        &#x2F;&#x2F;创建的节点不是序号最小节点，则监听前一个节点</span><br><span class="line">        if (!firstNode.equals(znode)) &#123;</span><br><span class="line">            String previousNode &#x3D; firstNode;</span><br><span class="line">            for (String node : childrenNodes) &#123;</span><br><span class="line">                &#x2F;&#x2F;寻找前一个节点</span><br><span class="line">                if (!znode.equals(node)) &#123;</span><br><span class="line">                    previousNode &#x3D; node;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    zooKeeper.exists(&quot;&#x2F;&quot; + businessName + &quot;&#x2F;&quot; + previousNode, true);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;等待线程释放锁</span><br><span class="line">            synchronized (this) &#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;创建的节点是序号最小节点，获得锁</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void process(WatchedEvent watchedEvent) &#123;</span><br><span class="line">        &#x2F;&#x2F;监听前一个节点删除事件，监听到事件发生，则唤醒线程</span><br><span class="line">        if (watchedEvent.getType() &#x3D;&#x3D; Event.EventType.NodeDeleted)&#123;</span><br><span class="line">            synchronized (this)&#123;</span><br><span class="line">                notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line">        zooKeeper.delete(&quot;&#x2F;&quot;+businessName+&quot;&#x2F;&quot;+znode,-1);</span><br><span class="line">        zooKeeper.close();</span><br><span class="line">        log.info(&quot;我释放了锁&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写一个controller检验一下加锁解锁的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.controller;</span><br><span class="line"></span><br><span class="line">import com.pd.distributelock.lock.ZkLock;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class ZkLockController &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;zkLock&quot;)</span><br><span class="line">    public String zkLock() &#123;</span><br><span class="line">        log.info(&quot;我进入了方法&quot;);</span><br><span class="line">        String connectString &#x3D; &quot;192.168.31.77:2181&quot;;</span><br><span class="line">        String businessName &#x3D; &quot;order&quot;;</span><br><span class="line">        try(ZkLock zkLock &#x3D; new ZkLock(connectString, businessName)) &#123;</span><br><span class="line">            if(zkLock.getLock()) &#123;</span><br><span class="line">                log.info(&quot;我进入了锁&quot;);</span><br><span class="line">                Thread.sleep(15000);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;方法执行完成&quot;);</span><br><span class="line">        return &quot;方法执行完成&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别以8080和8081端口同时启动两个应用<br>首先浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8080/zkLock">http://localhost:8080/zkLock</a><br>日志输出如下,在13:43:00获得了锁，线程休眠15秒后在13:43:15释放锁  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 13:43:00.564  INFO 10978 --- [nio-8080-exec-4] com.pd.distributelock.lock.ZkLock        : 瞬时有序节点：order_0000000007</span><br><span class="line">2021-02-20 13:43:00.602  INFO 10978 --- [nio-8080-exec-4] c.p.d.controller.ZkLockController        : 我进入了锁</span><br><span class="line">2021-02-20 13:43:15.748  INFO 10978 --- [nio-8080-exec-4] org.apache.zookeeper.ZooKeeper           : Session: 0x1002102995e0028 closed</span><br><span class="line">2021-02-20 13:43:15.748  INFO 10978 --- [c-4-EventThread] org.apache.zookeeper.ClientCnxn          : EventThread shut down for session: 0x1002102995e0028</span><br><span class="line">2021-02-20 13:43:15.749  INFO 10978 --- [nio-8080-exec-4] com.pd.distributelock.lock.ZkLock        : 我释放了锁</span><br><span class="line">2021-02-20 13:43:15.751  INFO 10978 --- [nio-8080-exec-4] c.p.d.controller.ZkLockController        : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>紧接着马上访问：<a target="_blank" rel="noopener" href="http://localhost:8081/zkLock">http://localhost:8081/zkLock</a><br>日志输出如下，在13:43:02进入方法，但是这时候另一个线程正占用着锁，直到另一个线程释放锁，在13:43:15获得锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 13:43:02.908  INFO 10985 --- [nio-8081-exec-4] com.pd.distributelock.lock.ZkLock        : 瞬时有序节点：order_0000000008</span><br><span class="line">2021-02-20 13:43:15.631  INFO 10985 --- [nio-8081-exec-4] c.p.d.controller.ZkLockController        : 我进入了锁</span><br><span class="line">2021-02-20 13:43:30.750  INFO 10985 --- [nio-8081-exec-4] org.apache.zookeeper.ZooKeeper           : Session: 0x1002102995e0029 closed</span><br><span class="line">2021-02-20 13:43:30.750  INFO 10985 --- [c-4-EventThread] org.apache.zookeeper.ClientCnxn          : EventThread shut down for session: 0x1002102995e0029</span><br><span class="line">2021-02-20 13:43:30.750  INFO 10985 --- [nio-8081-exec-4] com.pd.distributelock.lock.ZkLock        : 我释放了锁</span><br><span class="line">2021-02-20 13:43:30.752  INFO 10985 --- [nio-8081-exec-4] c.p.d.controller.ZkLockController        : 方法执行完成</span><br></pre></td></tr></table></figure>
<h2 id="基于zookeeper的curator客户端实现分布式锁"><a href="#基于zookeeper的curator客户端实现分布式锁" class="headerlink" title="基于zookeeper的curator客户端实现分布式锁"></a>基于zookeeper的curator客户端实现分布式锁</h2><p>通过上面的实现，我们看到线程一获得锁后，线程二会阻塞等待，直到线程一释放锁，线程二才获得锁，这里需要理解zookeeper的原理，程序较为复杂。那么有没有已经实现好的类库，可以直接调用就好？答案是有的。接下来将通过curator实现分布式锁。  </p>
<p>curator是Zookeeper的Java/JVM客户端，它包括一个高级API框架和实用程序，使得使用Zookeeper更加容易和可靠。关于curator项目的详细介绍可以在<a target="_blank" rel="noopener" href="http://curator.apache.org/">官方网站</a>找到。</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>引入curator的maven依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;curator-recipes&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.2.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>Application启动类注入bean</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock;</span><br><span class="line"></span><br><span class="line">import org.apache.curator.RetryPolicy;</span><br><span class="line">import org.apache.curator.framework.CuratorFramework;</span><br><span class="line">import org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line">import org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class Application &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(initMethod&#x3D;&quot;start&quot;,destroyMethod &#x3D; &quot;close&quot;)</span><br><span class="line">    public CuratorFramework getCuratorFramework() &#123;</span><br><span class="line">        RetryPolicy retryPolicy &#x3D; new ExponentialBackoffRetry(1000, 3);</span><br><span class="line">        CuratorFramework client &#x3D; CuratorFrameworkFactory.newClient(&quot;192.168.31.78:2181&quot;, retryPolicy);</span><br><span class="line">        return client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写一个controller检验一下加锁解锁的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.controller;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.curator.framework.CuratorFramework;</span><br><span class="line">import org.apache.curator.framework.recipes.locks.InterProcessMutex;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class CuratorController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private CuratorFramework client;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;curatorLock&quot;)</span><br><span class="line">    public String curatorLock() &#123;</span><br><span class="line">        log.info(&quot;我进入了方法&quot;);</span><br><span class="line">        InterProcessMutex lock &#x3D; new InterProcessMutex(client, &quot;&#x2F;order&quot;);</span><br><span class="line">        try&#123;</span><br><span class="line">            if(lock.acquire(30, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                log.info(&quot;我获得了锁&quot;);</span><br><span class="line">                Thread.sleep(10000);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                lock.release();</span><br><span class="line">                log.info(&quot;我释放了锁&quot;);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;方法执行完成&quot;);</span><br><span class="line">        return &quot;方法执行完成&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别以8080和8081端口同时启动两个应用<br>首先浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8080/curatorLock">http://localhost:8080/curatorLock</a><br>日志输出如下,在15:23:08获得了锁，线程休眠10秒后15:23:18释放锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 15:23:08.153  INFO 10978 --- [io-8080-exec-10] c.p.d.controller.CuratorController       : 我进入了方法</span><br><span class="line">2021-02-20 15:23:08.203  INFO 10978 --- [io-8080-exec-10] c.p.d.controller.CuratorController       : 我获得了锁</span><br><span class="line">2021-02-20 15:23:18.219  INFO 10978 --- [io-8080-exec-10] c.p.d.controller.CuratorController       : 我释放了锁</span><br><span class="line">2021-02-20 15:23:18.220  INFO 10978 --- [io-8080-exec-10] c.p.d.controller.CuratorController       : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>紧接着马上访问：<a target="_blank" rel="noopener" href="http://localhost:8081/curatorLock">http://localhost:8081/curatorLock</a><br>日志输出如下，在15:23:10进入方法，但是这时候另一个线程正占用着锁，直到另一个线程释放锁，在15:23:18获得锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 15:23:10.557  INFO 10985 --- [nio-8081-exec-1] c.p.d.controller.CuratorController       : 我进入了方法</span><br><span class="line">2021-02-20 15:23:18.466  INFO 10985 --- [nio-8081-exec-1] c.p.d.controller.CuratorController       : 我获得了锁</span><br><span class="line">2021-02-20 15:23:28.480  INFO 10985 --- [nio-8081-exec-1] c.p.d.controller.CuratorController       : 我释放了锁</span><br><span class="line">2021-02-20 15:23:28.480  INFO 10985 --- [nio-8081-exec-1] c.p.d.controller.CuratorController       : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>最后，源码地址：<a target="_blank" rel="noopener" href="https://github.com/dupeihui/distribute-lock-zk">https://github.com/dupeihui/distribute-lock-zk</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">基于Redis实现分布式锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-20 23:46:03" itemprop="dateCreated datePublished" datetime="2021-02-20T23:46:03+08:00">2021-02-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:49:18" itemprop="dateModified" datetime="2021-02-21T23:49:18+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>背景：在并发编程中，相信大家对锁的概念都很熟悉。不熟悉的小伙伴也可以通过以下文章回顾一下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1531449">什么是锁</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1532501">JAVA中锁的解决方案</a></li>
<li><a target="_blank" rel="noopener" href="https://www.pianshen.com/article/26761008680/">Java中单体应用锁的局限性&amp;分布式锁</a></li>
</ul>
<p>通过以上文章，我们知道单体应用锁是在一个JVM进程内有效，无法跨JVM、跨进程。那么这时候需要找到JVM可以共同访问的第三方组件，通过第三方组件实现分布式锁。目前比较流行的分布式锁的解决方案有：</p>
<ul>
<li>通过数据库悲观锁或者乐观锁实现分布式锁</li>
<li>通过Redis实现分布式锁</li>
<li>通过Zookeeper实现分布式锁</li>
</ul>
<p>接下来，本文将介绍分布式锁的一种实现：基于Redis实现分布式锁。</p>
<h2 id="基于Redis的setnx自实现简单分布式锁"><a href="#基于Redis的setnx自实现简单分布式锁" class="headerlink" title="基于Redis的setnx自实现简单分布式锁"></a>基于Redis的setnx自实现简单分布式锁</h2><h3 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h3><p>加锁的过程实际上就是在Redis设置一个键值对，为避免死锁，设定一个过期时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET lock_key random_value NX PX 5000</span><br></pre></td></tr></table></figure>
<p><code>random_value</code>是客户端生成的唯一字符串<br><code>NX</code>代表只在键不存在时，才对键进行设置操作<br><code>PX 5000</code>表示设置键的过期时间为5000毫秒</p>
<p>如果上面命令执行成功，则证明客户端获得了锁。</p>
<h3 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h3><p>解锁的过程就是将键key删除，但也不能乱删，不能说客户端1的请求将客户端2的锁给删除掉。这时候<code>random_value</code>的作用就体现出来。  </p>
<p>为了保证解锁操作的原子性，我们用LUA脚本完成这一操作。先判断当前锁的字符串是否与传入的值相等，是的话就删除Key，解锁成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if redis.call(&#39;get&#39;,KEYS[1]) &#x3D;&#x3D; ARGV[1] then</span><br><span class="line">   return redis.call(&#39;del&#39;,KEYS[1])</span><br><span class="line">else</span><br><span class="line">   return 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>这里基于SpringBoot项目实现，首先引入redis客户端maven依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>Redis加锁解锁的实现类RedisLock.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.lock;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.data.redis.connection.RedisStringCommands;</span><br><span class="line">import org.springframework.data.redis.core.RedisCallback;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.data.redis.core.script.RedisScript;</span><br><span class="line">import org.springframework.data.redis.core.types.Expiration;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.UUID;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class RedisLock implements AutoCloseable &#123;</span><br><span class="line"></span><br><span class="line">    private RedisTemplate redisTemplate;</span><br><span class="line">    private String key;</span><br><span class="line">    private String value;</span><br><span class="line">    &#x2F;&#x2F;单位：秒</span><br><span class="line">    private int expireTime;</span><br><span class="line"></span><br><span class="line">    public RedisLock(RedisTemplate redisTemplate, String key, int expireTime) &#123;</span><br><span class="line">        this.redisTemplate &#x3D; redisTemplate;</span><br><span class="line">        this.key &#x3D; key;</span><br><span class="line">        this.value &#x3D; UUID.randomUUID().toString();</span><br><span class="line">        this.expireTime &#x3D; expireTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取分布式锁</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean getLock() &#123;</span><br><span class="line">        RedisCallback&lt;Boolean&gt; redisCallback &#x3D; connection -&gt; &#123;</span><br><span class="line">            &#x2F;&#x2F;设置NX</span><br><span class="line">            RedisStringCommands.SetOption setOption &#x3D; RedisStringCommands.SetOption.ifAbsent();</span><br><span class="line">            &#x2F;&#x2F;设置过期时间</span><br><span class="line">            Expiration expiration &#x3D; Expiration.seconds(expireTime);</span><br><span class="line">            &#x2F;&#x2F;序列化key</span><br><span class="line">            byte[] redisKey &#x3D; redisTemplate.getKeySerializer().serialize(key);</span><br><span class="line">            &#x2F;&#x2F;序列化value</span><br><span class="line">            byte[] redisValue &#x3D; redisTemplate.getValueSerializer().serialize(value);</span><br><span class="line">            &#x2F;&#x2F;执行setnx操作</span><br><span class="line">            Boolean result &#x3D; connection.set(redisKey, redisValue, expiration, setOption);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;;</span><br><span class="line">        Boolean lock &#x3D; (Boolean) redisTemplate.execute(redisCallback);</span><br><span class="line">        return lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean unlock() &#123;</span><br><span class="line">        &#x2F;&#x2F;保证解锁操作的原子性，使用LUA脚本</span><br><span class="line">        String script &#x3D; &quot;if redis.call(&#39;get&#39;,KEYS[1]) &#x3D;&#x3D; ARGV[1] then\n&quot; +</span><br><span class="line">                        &quot;    return redis.call(&#39;del&#39;,KEYS[1])\n&quot; +</span><br><span class="line">                        &quot;else\n&quot; +</span><br><span class="line">                        &quot;    return 0\n&quot; +</span><br><span class="line">                        &quot;end&quot;;</span><br><span class="line"></span><br><span class="line">        RedisScript&lt;Boolean&gt; redisScript &#x3D; RedisScript.of(script,Boolean.class);</span><br><span class="line">        List&lt;String&gt; keys &#x3D; Arrays.asList(key);</span><br><span class="line"></span><br><span class="line">        Boolean result &#x3D; (Boolean)redisTemplate.execute(redisScript, keys, value);</span><br><span class="line">        log.info(&quot;释放锁的结果：&quot;+result);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，写一个controller检验一下加锁解锁的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.controller;</span><br><span class="line"></span><br><span class="line">import com.pd.distributelock.lock.RedisLock;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class RedisLockController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;redisLock&quot;)</span><br><span class="line">    public String RedisLock() &#123;</span><br><span class="line">        log.info(&quot;我进入了方法&quot;);</span><br><span class="line">        try(RedisLock redisLock &#x3D; new RedisLock(redisTemplate, &quot;redisKey&quot;, 30)) &#123;</span><br><span class="line">            if(redisLock.getLock()) &#123;</span><br><span class="line">                log.info(&quot;我进入了锁&quot;);</span><br><span class="line">                Thread.sleep(15000);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;方法执行完成&quot;);</span><br><span class="line">        return &quot;方法执行完成&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别以8080和8081端口同时启动两个应用<br>首先浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8080/redisLock">http://localhost:8080/redisLock</a><br>日志输出如下,在11:08:39获得了锁，线程休眠15秒后在11:08:54释放锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 11:08:38.953  INFO 6685 --- [nio-8080-exec-1] c.p.d.controller.RedisLockController     : 我进入了方法</span><br><span class="line">2021-02-20 11:08:39.019  INFO 6685 --- [nio-8080-exec-1] c.p.d.controller.RedisLockController     : 我进入了锁</span><br><span class="line">2021-02-20 11:08:54.033  INFO 6685 --- [nio-8080-exec-1] com.pd.distributelock.lock.RedisLock     : 释放锁的结果：true</span><br><span class="line">2021-02-20 11:08:54.034  INFO 6685 --- [nio-8080-exec-1] c.p.d.controller.RedisLockController     : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>紧接着马上访问：<a target="_blank" rel="noopener" href="http://localhost:8081/redisLock">http://localhost:8081/redisLock</a><br>日志输出如下，在11:08:41进入方法，但是这时候另一个线程正占用着锁，所以这里获取锁失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 11:08:41.096  INFO 6691 --- [nio-8081-exec-1] c.p.d.controller.RedisLockController     : 我进入了方法</span><br><span class="line">2021-02-20 11:08:41.155  INFO 6691 --- [nio-8081-exec-1] com.pd.distributelock.lock.RedisLock     : 释放锁的结果：false</span><br><span class="line">2021-02-20 11:08:41.155  INFO 6691 --- [nio-8081-exec-1] c.p.d.controller.RedisLockController     : 方法执行完成</span><br></pre></td></tr></table></figure>
<h2 id="基于Redisson的可重入锁实现分布式锁"><a href="#基于Redisson的可重入锁实现分布式锁" class="headerlink" title="基于Redisson的可重入锁实现分布式锁"></a>基于Redisson的可重入锁实现分布式锁</h2><p>在上面实现的代码中，很明显，线程一获得了锁，而线程二获取不到锁就执行失败了，线程二并不会阻塞等待或者异步执行获取锁，也就是说锁是不可重入的，这样是有问题的。接下来将介绍Redisson的可重入锁（Reentrant Lock）。  </p>
<p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid），Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。关于Redisson项目的详细介绍可以在<a target="_blank" rel="noopener" href="https://redisson.org/">官方网站</a>找到。</p>
<h3 id="加锁-1"><a href="#加锁-1" class="headerlink" title="加锁"></a>加锁</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RLock lock &#x3D; redisson.getLock(&quot;anyLock&quot;);</span><br><span class="line">&#x2F;&#x2F; 最常见的使用方法</span><br><span class="line">lock.lock();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 加锁以后10秒钟自动解锁</span><br><span class="line">&#x2F;&#x2F; 无需调用unlock方法手动解锁</span><br><span class="line">lock.lock(10, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<h3 id="解锁-1"><a href="#解锁-1" class="headerlink" title="解锁"></a>解锁</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock.unlock();</span><br></pre></td></tr></table></figure>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>引入maven依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.redisson&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;redisson-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.15.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>写一个controller检验一下加锁解锁的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.distributelock.controller;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class RedissonLockController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;redissonLock&quot;)</span><br><span class="line">    public String redissonLock() &#123;</span><br><span class="line">        RLock rLock &#x3D; redissonClient.getLock(&quot;order&quot;);</span><br><span class="line">        log.info(&quot;我进入了方法&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 加锁以后15秒钟自动解锁</span><br><span class="line">            rLock.lock(15, TimeUnit.SECONDS);</span><br><span class="line">            log.info(&quot;我获得了锁&quot;);</span><br><span class="line">            Thread.sleep(10000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            rLock.unlock();</span><br><span class="line">            log.info(&quot;我释放了锁&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;方法执行完成&quot;);</span><br><span class="line">        return &quot;方法执行完成&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别以8080和8081端口同时启动两个应用<br>首先浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8080/redissonLock">http://localhost:8080/redissonLock</a><br>日志输出如下,在11:42:49获得了锁，线程休眠10秒后在11:42:59释放锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 11:42:48.943  INFO 6685 --- [nio-8080-exec-4] c.p.d.controller.RedissonLockController  : 我进入了方法</span><br><span class="line">2021-02-20 11:42:49.623  INFO 6685 --- [nio-8080-exec-4] c.p.d.controller.RedissonLockController  : 我获得了锁</span><br><span class="line">2021-02-20 11:42:59.653  INFO 6685 --- [nio-8080-exec-4] c.p.d.controller.RedissonLockController  : 我释放了锁</span><br><span class="line">2021-02-20 11:42:59.655  INFO 6685 --- [nio-8080-exec-4] c.p.d.controller.RedissonLockController  : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>紧接着马上访问：<a target="_blank" rel="noopener" href="http://localhost:8081/redissonLock">http://localhost:8081/redissonLock</a><br>日志输出如下，在11:42:51进入方法，但是这时候另一个线程正占用着锁，这里阻塞等待，直到另一个线程释放锁，在11:42:59获得锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2021-02-20 11:42:51.170  INFO 6691 --- [nio-8081-exec-4] c.p.d.controller.RedissonLockController  : 我进入了方法</span><br><span class="line">2021-02-20 11:42:59.667  INFO 6691 --- [nio-8081-exec-4] c.p.d.controller.RedissonLockController  : 我获得了锁</span><br><span class="line">2021-02-20 11:43:09.690  INFO 6691 --- [nio-8081-exec-4] c.p.d.controller.RedissonLockController  : 我释放了锁</span><br><span class="line">2021-02-20 11:43:09.691  INFO 6691 --- [nio-8081-exec-4] c.p.d.controller.RedissonLockController  : 方法执行完成</span><br></pre></td></tr></table></figure>
<p>最后，源码地址：<a target="_blank" rel="noopener" href="https://github.com/dupeihui/distribute-lock-redis">https://github.com/dupeihui/distribute-lock-redis</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/" class="post-title-link" itemprop="url">基于Kafka、ELK搭建高吞吐量日志收集平台</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-19 23:36:53" itemprop="dateCreated datePublished" datetime="2021-02-19T23:36:53+08:00">2021-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:43:20" itemprop="dateModified" datetime="2021-02-21T23:43:20+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文将基于Kafka、ELK技术栈实现日志输出（log4j2）、日志收集（FileBeat）、数据转储（Kafka）、日志过滤（Logstash）、日志持久化（Elasticsearch）、日志可视化（Kibana）。全流程搭建一个高吞吐量日志收集平台。</p>
</blockquote>
<p><strong>ELK技术栈架构图</strong></p>
<img src="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/ELK-arch-1.png" class="">

<p><strong>ELK实战流程图</strong></p>
<img src="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/ELK-arch-2.png" class="">

<p>接下来将根据实战流程图展开实际操作，包含以下几个部分：  </p>
<ul>
<li><p><strong>日志输出（log4j2）</strong></p>
</li>
<li><p><strong>日志收集（FileBeat）</strong></p>
</li>
<li><p><strong>数据转储（Kafka）</strong></p>
</li>
<li><p><strong>日志过滤（Logstash）</strong></p>
</li>
<li><p><strong>日志持久化（Elasticsearch）</strong></p>
</li>
<li><p><strong>日志可视化（Kibana）</strong></p>
</li>
</ul>
<h2 id="Step-1：日志输出（log4j2）"><a href="#Step-1：日志输出（log4j2）" class="headerlink" title="Step 1：日志输出（log4j2）"></a>Step 1：日志输出（log4j2）</h2><blockquote>
<p>这部分将模拟一个简单SpringBoot应用，利用log4j2将日志输出到控制台以及日志文件。</p>
</blockquote>
<p>pom.xml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.pd&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-elk&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;!-- 	排除spring-boot-starter-logging --&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;spring-boot-starter-logging&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;&#x2F;exclusion&gt;</span><br><span class="line">            &lt;&#x2F;exclusions&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!-- log4j2 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-log4j2&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.lmax&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;disruptor&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.3.4&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.58&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;finalName&gt;kafka-elk&lt;&#x2F;finalName&gt;</span><br><span class="line">        &lt;!-- 打包时包含properties、xml --&gt;</span><br><span class="line">        &lt;resources&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src&#x2F;main&#x2F;java&lt;&#x2F;directory&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**&#x2F;*.properties&lt;&#x2F;include&gt;</span><br><span class="line">                    &lt;include&gt;**&#x2F;*.xml&lt;&#x2F;include&gt;</span><br><span class="line">                &lt;&#x2F;includes&gt;</span><br><span class="line">                &lt;!-- 是否替换资源中的属性--&gt;</span><br><span class="line">                &lt;filtering&gt;true&lt;&#x2F;filtering&gt;</span><br><span class="line">            &lt;&#x2F;resource&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src&#x2F;main&#x2F;resources&lt;&#x2F;directory&gt;</span><br><span class="line">            &lt;&#x2F;resource&gt;</span><br><span class="line">        &lt;&#x2F;resources&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;mainClass&gt;com.pd.elk.Application&lt;&#x2F;mainClass&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>application.properties配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.context-path&#x3D;&#x2F;</span><br><span class="line">server.port&#x3D;8001</span><br><span class="line"></span><br><span class="line">spring.application.name&#x3D;elk</span><br><span class="line">spring.http.encoding.charset&#x3D;UTF-8</span><br><span class="line">spring.jackson.date-format&#x3D;yyyy-MM-dd HH:mm:ss</span><br><span class="line">spring.jackson.time-zone&#x3D;GMT+8</span><br><span class="line">spring.jackson.default-property-inclusion&#x3D;NON_NULL</span><br></pre></td></tr></table></figure>
<p>log4j2.xml配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!--Configuration后面的status，这个用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，你会看到log4j2内部各种详细输出--&gt;</span><br><span class="line">&lt;!--monitorInterval：Log4j2能够自动检测修改配置 文件和重新配置本身，设置间隔秒数--&gt;</span><br><span class="line">&lt;Configuration status&#x3D;&quot;INFO&quot; schema&#x3D;&quot;Log4J-V2.0.xsd&quot; monitorInterval&#x3D;&quot;600&quot; &gt;</span><br><span class="line">    &lt;!--日志级别以及优先级排序: OFF &gt; FATAL &gt; ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE &gt; ALL --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--变量配置--&gt;</span><br><span class="line">    &lt;Properties&gt;</span><br><span class="line">        &lt;Property name&#x3D;&quot;LOG_HOME&quot;&gt;logs&lt;&#x2F;Property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;FILE_NAME&quot;&gt;elk&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;!-- 格式化输出：%d表示日期，%-5level：级别从左显示5个字符宽度，%thread表示线程名，%tid表示线程id，%logger表示当前执行类的全名，%X表示MDC方式获取自定义属性，%F表示当前执行类名，%L表示行号，%C表示全类名，%M表示方法 %msg：日志消息，%ex表示异常信息，%n是换行符--&gt;</span><br><span class="line">        &lt;!--yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ UTC日期格式，即世界标准时间，在此基础上加上8个小时就得到北京时间--&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;patternLayout&quot;&gt;[%d&#123;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ&#125;] [%level&#123;length&#x3D;5&#125;] [%thread-%tid] [%logger] [%X&#123;hostName&#125;] [%X&#123;ip&#125;] [%X&#123;applicationName&#125;] [%F,%L,%C,%M] [%m] ## &#39;%ex&#39;%n&lt;&#x2F;property&gt;</span><br><span class="line">    &lt;&#x2F;Properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Appenders&gt;</span><br><span class="line">        &lt;!--控制台打印所有日志--&gt;</span><br><span class="line">        &lt;Console name&#x3D;&quot;CONSOLE&quot; target&#x3D;&quot;SYSTEM_OUT&quot;&gt;</span><br><span class="line">            &lt;PatternLayout pattern&#x3D;&quot;$&#123;patternLayout&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;Console&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--输出所有日志到文件，每次大小超过size，按指定格式新建日志文件--&gt;</span><br><span class="line">        &lt;!--filePattern : 指定当发生Rolling时，文件的转移和重命名规则。--&gt;</span><br><span class="line">        &lt;RollingRandomAccessFile name&#x3D;&quot;appAppender&quot; fileName&#x3D;&quot;$&#123;LOG_HOME&#125;&#x2F;app-$&#123;FILE_NAME&#125;.log&quot; filePattern&#x3D;&quot;$&#123;LOG_HOME&#125;&#x2F;app-$&#123;FILE_NAME&#125;-%d&#123;yyyy-MM-dd&#125;-%i.log&quot; &gt;</span><br><span class="line">            &lt;PatternLayout pattern&#x3D;&quot;$&#123;patternLayout&#125;&quot; &#x2F;&gt;</span><br><span class="line">            &lt;!--Policies:指定滚动日志的策略，就是什么时候进行新建日志文件输出日志--&gt;</span><br><span class="line">            &lt;Policies&gt;</span><br><span class="line">                &lt;!--interval属性用来指定多久滚动一次，默认是1 hour--&gt;</span><br><span class="line">                &lt;TimeBasedTriggeringPolicy interval&#x3D;&quot;1&quot;&#x2F;&gt;</span><br><span class="line">                &lt;SizeBasedTriggeringPolicy size&#x3D;&quot;50MB&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;Policies&gt;</span><br><span class="line">            &lt;!-- DefaultRolloverStrategy属性如不设置，则默认为最多同一文件夹下7个文件开始覆盖--&gt;</span><br><span class="line">            &lt;DefaultRolloverStrategy max&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;RollingRandomAccessFile&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--输出warn及以上级别日志到文件--&gt;</span><br><span class="line">        &lt;RollingRandomAccessFile name&#x3D;&quot;errorAppender&quot; fileName&#x3D;&quot;$&#123;LOG_HOME&#125;&#x2F;error-$&#123;FILE_NAME&#125;.log&quot; filePattern&#x3D;&quot;$&#123;LOG_HOME&#125;&#x2F;error-$&#123;FILE_NAME&#125;-%d&#123;yyyy-MM-dd&#125;-%i.log&quot; &gt;</span><br><span class="line">            &lt;PatternLayout pattern&#x3D;&quot;$&#123;patternLayout&#125;&quot; &#x2F;&gt;</span><br><span class="line">            &lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span><br><span class="line">            &lt;Filters&gt;</span><br><span class="line">                &lt;ThresholdFilter level&#x3D;&quot;warn&quot; onMatch&#x3D;&quot;ACCEPT&quot; onMismatch&#x3D;&quot;DENY&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;Filters&gt;</span><br><span class="line">            &lt;Policies&gt;</span><br><span class="line">                &lt;TimeBasedTriggeringPolicy interval&#x3D;&quot;1&quot;&#x2F;&gt;</span><br><span class="line">                &lt;SizeBasedTriggeringPolicy size&#x3D;&quot;50MB&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;Policies&gt;</span><br><span class="line">            &lt;DefaultRolloverStrategy max&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;RollingRandomAccessFile&gt;</span><br><span class="line">    &lt;&#x2F;Appenders&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Loggers&gt;</span><br><span class="line">        &lt;!-- 业务相关 异步logger --&gt;</span><br><span class="line">        &lt;AsyncLogger name&#x3D;&quot;com.pd.*&quot; level&#x3D;&quot;info&quot; includeLocation&#x3D;&quot;true&quot;&gt;</span><br><span class="line">            &lt;AppenderRef ref&#x3D;&quot;appAppender&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;AsyncLogger&gt;</span><br><span class="line">        &lt;AsyncLogger name&#x3D;&quot;com.pd.*&quot; level&#x3D;&quot;info&quot; includeLocation&#x3D;&quot;true&quot;&gt;</span><br><span class="line">            &lt;AppenderRef ref&#x3D;&quot;errorAppender&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;AsyncLogger&gt;</span><br><span class="line">        &lt;Root level&#x3D;&quot;info&quot;&gt;</span><br><span class="line">            &lt;Appender-Ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">            &lt;Appender-Ref ref&#x3D;&quot;appAppender&quot;&#x2F;&gt;</span><br><span class="line">            &lt;AppenderRef ref&#x3D;&quot;errorAppender&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;Root&gt;</span><br><span class="line">    &lt;&#x2F;Loggers&gt;</span><br><span class="line">&lt;&#x2F;Configuration&gt;</span><br></pre></td></tr></table></figure>
<p>应用访问接口IndexController：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.elk.controller;</span><br><span class="line"></span><br><span class="line">import com.pd.elk.util.InputMDC;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class IndexController &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value &#x3D; &quot;&#x2F;index&quot;)</span><br><span class="line">    public String index()&#123;</span><br><span class="line">        InputMDC.putMDC();</span><br><span class="line">        log.info(&quot;我是一条info日志&quot;);</span><br><span class="line">        log.warn(&quot;我是一条warn日志&quot;);</span><br><span class="line">        log.error(&quot;我是一条error日志&quot;);</span><br><span class="line">        return &quot;hello world!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value &#x3D; &quot;&#x2F;err&quot;)</span><br><span class="line">    public String error()&#123;</span><br><span class="line">        InputMDC.putMDC();</span><br><span class="line">        try &#123;</span><br><span class="line">            int a &#x3D; 1&#x2F;0;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;算术异常&quot;,e);</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>源码地址：</strong> <a target="_blank" rel="noopener" href="https://github.com/dupeihui/kafka-elk">https://github.com/dupeihui/kafka-elk</a></p>
<p>在IDEA中运行项目，会在工程目录下生成logs文件夹和两个日志文件app-elk.log,error-elk.log<br>控制台打印出的日志格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2021-02-17T21:44:06.084+08:00] [INFO] [main-1] [com.pd.elk.Application] [] [] [] [StartupInfoLogger.java,59,org.springframework.boot.StartupInfoLogger,logStarted] [Started Application in 1.818 seconds (JVM running for 3.58)] ## &#39;&#39;</span><br></pre></td></tr></table></figure>
<p>通过<code>maven install</code>在target目录下生成kafka-elk.jar，并将这个jar包上传到linux服务器上<br>在linux服务器中运行这个应用，相应的日志文件在<code>./logs/</code>目录下，如下图:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 后台运行jar命令，输出记录在nohup.out文件中</span><br><span class="line">nohup java -jar kafka-elk.jar &amp;</span><br></pre></td></tr></table></figure>
<img src="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/elk-1.png" class="">

<h2 id="Step-2：日志收集（FileBeat）"><a href="#Step-2：日志收集（FileBeat）" class="headerlink" title="Step 2：日志收集（FileBeat）"></a>Step 2：日志收集（FileBeat）</h2><blockquote>
<p>Step 1已经将日志文件准备完毕，这时候FileBeat派上用场了，FileBeat作为日志采集器，我们将利用它实时的采集log文件中的新增数据，同时作为后续kafka broker的生产端，将数据转发到broker中。因为作为kafka broker生产端，所以其实是需要先启动kafka，并创建相应的topic。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 在elastic官网下载filebeat并进行安装</span><br><span class="line">tar -zxvf filebeat-7.10.1-linux-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line"></span><br><span class="line"># 重命名</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">mv filebeat-7.10.1-linux-x86_64&#x2F; filebeat-7.10.1</span><br><span class="line"></span><br><span class="line"># 配置filebeat.yml，filebeat.yml将在后面单独提供</span><br><span class="line">vim &#x2F;usr&#x2F;local&#x2F;filebeat-7.10.1&#x2F;filebeat.yml</span><br><span class="line"></span><br><span class="line"># 后台启动filebeat，启动日志输出到filebeat.log</span><br><span class="line">nohup .&#x2F;filebeat &gt; filebeat.log &amp;</span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">ps -ef | grep filebeat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启动kafka</span><br><span class="line">bin&#x2F;kafka-server-start.sh -daemon config&#x2F;server.propertie</span><br><span class="line"></span><br><span class="line"># 查看topic列表：</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --list</span><br><span class="line"></span><br><span class="line"># 创建topic</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --create --topic app-log-elk --partitions 1  --replication-factor 1</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --create --topic error-log-elk --partitions 1  --replication-factor 1</span><br></pre></td></tr></table></figure>
<p><strong>filebeat.yml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line"></span><br><span class="line">- input_type: log</span><br><span class="line"></span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;usr&#x2F;local&#x2F;logs&#x2F;app-elk.log</span><br><span class="line">  #定义写入ES时的 _type 值</span><br><span class="line">  document_type: &quot;app-log&quot;</span><br><span class="line">  multiline:</span><br><span class="line">    pattern: &#39;^\[&#39;						# 指定匹配的表达式（匹配以‘[’开头的字符串）</span><br><span class="line">    negate: true							# 是否匹配到</span><br><span class="line">    match: after							# 合并到上一行的末尾</span><br><span class="line">    max_lines: 2000						# 最大的行数</span><br><span class="line">    timeout: 2s								# 如果在规定时间没有新的日志事件就不等待后面的日志</span><br><span class="line">  fields:</span><br><span class="line">    logbiz: elk</span><br><span class="line">    logtopic: app-log-elk			# 按服务划分用作kafka topic</span><br><span class="line">    env: dev</span><br><span class="line"></span><br><span class="line">- input_type: log</span><br><span class="line"></span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;usr&#x2F;local&#x2F;logs&#x2F;error-elk.log</span><br><span class="line">  #定义写入ES时的 _type 值</span><br><span class="line">  document_type: &quot;error-log&quot;</span><br><span class="line">  multiline:</span><br><span class="line">    pattern: &#39;^\[&#39;						# 指定匹配的表达式（匹配以‘[’开头的字符串）</span><br><span class="line">    negate: true							# 是否匹配到</span><br><span class="line">    match: after							# 合并到上一行的末尾</span><br><span class="line">    max_lines: 2000						# 最大的行数</span><br><span class="line">    timeout: 2s								# 如果在规定时间没有新的日志事件就不等待后面的日志</span><br><span class="line">  fields:</span><br><span class="line">    logbiz: elk</span><br><span class="line">    logtopic: error-log-elk			# 按服务划分用作kafka topic</span><br><span class="line">    env: dev</span><br><span class="line"></span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;localhost:9092&quot;]</span><br><span class="line">  topic: &#39;%&#123;[fields.logtopic]&#125;&#39;</span><br><span class="line">  partition.hash:</span><br><span class="line">    reachable_only: true</span><br><span class="line">  compression: gzip</span><br><span class="line">  max_message_bytes: 1000000</span><br><span class="line">  required_acks: 1</span><br><span class="line">logging.to_files: true</span><br></pre></td></tr></table></figure>
<h2 id="Step-3：数据转储（Kafka）"><a href="#Step-3：数据转储（Kafka）" class="headerlink" title="Step 3：数据转储（Kafka）"></a>Step 3：数据转储（Kafka）</h2><blockquote>
<p>Step 2已经中filebeat作为kafka broker的生产端，已经将app-elk.log和error-elk.log中的新增数据实时转发到broker中指定的两个topic：app-log-elk,error-log-elk。</p>
</blockquote>
<h2 id="Step-4：日志过滤（Logstash）"><a href="#Step-4：日志过滤（Logstash）" class="headerlink" title="Step 4：日志过滤（Logstash）"></a>Step 4：日志过滤（Logstash）</h2><blockquote>
<p>Step 3中kafka broker已经有数据了，这时候Logstash作为对接kafka broker的消费端，消费日志信息，过滤日志，对接Elasticsearch，将数据sink到ES。同样，为了能够让数据持久化到ES，所以在这里是需要提前启动ES的。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 在elastic官网下载logstash并进行安装</span><br><span class="line">tar -zxvf logstash-7.10.1-linux-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line"></span><br><span class="line"># 创建script目录，并在script目录下创建logstash-script.conf配置文件，logstash-script.conf将在后面单独提供</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;logstash-7.10.1</span><br><span class="line">mkdir script</span><br><span class="line"></span><br><span class="line"># 启动logstash</span><br><span class="line">bin&#x2F;logstash -f script&#x2F;logstash-script.conf</span><br></pre></td></tr></table></figure>
<p><strong>logstash-script.conf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    ## app-log-服务名称</span><br><span class="line">    topics_pattern &#x3D;&gt; &quot;app-log-.*&quot;</span><br><span class="line">    bootstrap_servers &#x3D;&gt; &quot;localhost:9092&quot;</span><br><span class="line">    codec &#x3D;&gt; json</span><br><span class="line">    consumer_threads &#x3D;&gt; 1    # 增加consumer的并行消费线程数</span><br><span class="line">    decorate_events &#x3D;&gt; true</span><br><span class="line">    #auto_offset_rest &#x3D;&gt; &quot;latest&quot;</span><br><span class="line">    group_id &#x3D;&gt; &quot;app-log-group&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  kafka &#123;</span><br><span class="line">    ## error-log-服务名称</span><br><span class="line">    topics_pattern &#x3D;&gt; &quot;error-log-.*&quot;</span><br><span class="line">    bootstrap_servers &#x3D;&gt; &quot;localhost:9092&quot;</span><br><span class="line">    codec &#x3D;&gt; json</span><br><span class="line">    consumer_threads &#x3D;&gt; 1    # 增加consumer的并行消费线程数</span><br><span class="line">    decorate_events &#x3D;&gt; true</span><br><span class="line">    #auto_offset_rest &#x3D;&gt; &quot;latest&quot;</span><br><span class="line">    group_id &#x3D;&gt; &quot;error-log-group&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line"></span><br><span class="line">  ## 时区转换</span><br><span class="line">  ruby &#123;</span><br><span class="line">    code &#x3D;&gt; &quot;event.set(&#39;index_time&#39;,event.timestamp.time.localtime.strftime(&#39;%Y.%m.%d&#39;))&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if &quot;app-log&quot; in [fields][logtopic]&#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      #表达式</span><br><span class="line">      match &#x3D;&gt; [&quot;message&quot;,&quot;\[%&#123;NOTSPACE:currentDateTime&#125;\] \[%&#123;NOTSPACE:level&#125;\] \[%&#123;NOTSPACE:thread-id&#125;\] \[%&#123;NOTSPACE:class&#125;\] \[%&#123;DATA:hostName&#125;\] \[%&#123;DATA:ip&#125;\] \[%&#123;DATA:applicationName&#125;\] \[%&#123;DATA:location&#125;\] \[%&#123;DATA:messageInfo&#125;\] ## (\&#39;\&#39;|%&#123;QUOTEDSTRING:throwable&#125;)&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if &quot;error-log&quot; in [fields][logtopic]&#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      #表达式</span><br><span class="line">      match &#x3D;&gt; [&quot;message&quot;,&quot;\[%&#123;NOTSPACE:currentDateTime&#125;\] \[%&#123;NOTSPACE:level&#125;\] \[%&#123;NOTSPACE:thread-id&#125;\] \[%&#123;NOTSPACE:class&#125;\] \[%&#123;DATA:hostName&#125;\] \[%&#123;DATA:ip&#125;\] \[%&#123;DATA:applicationName&#125;\] \[%&#123;DATA:location&#125;\] \[%&#123;DATA:messageInfo&#125;\] ## (\&#39;\&#39;|%&#123;QUOTEDSTRING:throwable&#125;)&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#测试输出到控制台</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;codec &#x3D;&gt; rubydebug&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#输出到elasticsearch</span><br><span class="line">output &#123;</span><br><span class="line">  if &quot;app-log&quot; in [fields][logtopic]&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">      index &#x3D;&gt; &quot;app-log-%&#123;[fields][logbiz]&#125;-%&#123;index_time&#125;&quot;</span><br><span class="line">      sniffing &#x3D;&gt; true</span><br><span class="line">      template_overwrite &#x3D;&gt; true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if &quot;error-log&quot; in [fields][logtopic]&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">      index &#x3D;&gt; &quot;error-log-%&#123;[fields][logbiz]&#125;-%&#123;index_time&#125;&quot;</span><br><span class="line">      sniffing &#x3D;&gt; true</span><br><span class="line">      template_overwrite &#x3D;&gt; true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Step-5：日志持久化（Elasticsearch）"><a href="#Step-5：日志持久化（Elasticsearch）" class="headerlink" title="Step 5：日志持久化（Elasticsearch）"></a>Step 5：日志持久化（Elasticsearch）</h2><blockquote>
<p>Step 4已经将数据持久化到ES，这时候其实我们是可以通过ES-API去查询数据是否落入ES，为了步骤完整，这里还是会说明一下ES的安装和启动。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 在elastic官网下载elasticsearch并进行安装</span><br><span class="line">tar -zxvf elasticsearch-7.10.1-linux-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line"></span><br><span class="line"># 修改config&#x2F;elasticsearch.yml配置文件</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1&#x2F;config</span><br><span class="line">vim elasticsearch.yml</span><br><span class="line">## elasticsearch.yml中修改以下配置</span><br><span class="line">cluster.name: my-elasticsearch</span><br><span class="line">node.name: node-1</span><br><span class="line">path.data: &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1&#x2F;data</span><br><span class="line">path.logs: &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1&#x2F;logs</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line"></span><br><span class="line"># 创建目录</span><br><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1&#x2F;data</span><br><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1&#x2F;logs</span><br><span class="line"></span><br><span class="line"># 启动elasticsearch，ES不能以root用户运行，这里添加elasticsearch用户，并用这个用户启动ES服务</span><br><span class="line">useradd elasticsearch</span><br><span class="line">chown -R elasticsearch:elasticsearch &#x2F;usr&#x2F;local&#x2F;elasticsearch-7.10.1</span><br><span class="line">su elasticsearch</span><br><span class="line">## 启动</span><br><span class="line">bin&#x2F;elasticsearch</span><br></pre></td></tr></table></figure>
<h2 id="Step-6：日志可视化（Kibana）"><a href="#Step-6：日志可视化（Kibana）" class="headerlink" title="Step 6：日志可视化（Kibana）"></a>Step 6：日志可视化（Kibana）</h2><blockquote>
<p>Step 5已经把数据持久化到ES了，这时候只需要让Kibana对接ES，做数据的展示。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 在elastic官网下载kibana并进行安装</span><br><span class="line">tar -zxvf kibana-7.10.1-linux-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line"></span><br><span class="line"># 修改config&#x2F;kibana.yml配置文件</span><br><span class="line">vim &#x2F;usr&#x2F;local&#x2F;kibana-7.10.1&#x2F;config&#x2F;kibana.yml</span><br><span class="line">## kibana.yml中修改以下配置</span><br><span class="line">server.port: 5601</span><br><span class="line">server.host: &quot;192.168.31.75&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http:&#x2F;&#x2F;localhost:9200&quot;]</span><br><span class="line"></span><br><span class="line"># 启动kibana，不能root用户运行，使用elasticsearch用户</span><br><span class="line">su elasticsearch</span><br><span class="line">bin&#x2F;kibana</span><br></pre></td></tr></table></figure>
<p>大功告成！Kibana中数据展示效果如下：</p>
<img src="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/elk-2.png" class="">

<img src="/2021/02/19/%E5%9F%BA%E4%BA%8EKafka%E3%80%81ELK%E6%90%AD%E5%BB%BA%E9%AB%98%E5%90%9E%E5%90%90%E9%87%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/elk-3.png" class="">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/18/Kafka%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/18/Kafka%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/" class="post-title-link" itemprop="url">Kafka快速安装以及与SpringBoot2.x整合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-18 17:31:41" itemprop="dateCreated datePublished" datetime="2021-02-18T17:31:41+08:00">2021-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:20:55" itemprop="dateModified" datetime="2021-02-23T21:20:55+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="快速安装单机版Kafka"><a href="#快速安装单机版Kafka" class="headerlink" title="快速安装单机版Kafka"></a>快速安装单机版Kafka</h2><ul>
<li>kafka下载地址：<a target="_blank" rel="noopener" href="http://kafka.apache.org/downloads">http://kafka.apache.org/downloads</a></li>
<li>kafka依赖与zookeeper，所以需要提前安装好zookeeper</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 解压命令</span><br><span class="line">tar -zxvf kafka_2.13-2.7.0.tgz -C &#x2F;usr&#x2F;local</span><br><span class="line"># 进入解压后的目录，修改server.properties文件：</span><br><span class="line">vim &#x2F;usr&#x2F;local&#x2F;kafka_2.13-2.7.0&#x2F;config&#x2F;server.propertie</span><br><span class="line"># 修改配置</span><br><span class="line">log.dirs&#x3D;&#x2F;usr&#x2F;local&#x2F;kafka_2.13-2.7.0&#x2F;kafka-logs</span><br><span class="line">num.partitions&#x3D;2</span><br><span class="line">zookeeper.connect&#x3D;localhost:2181</span><br><span class="line"></span><br><span class="line"># 建立日志文件夹</span><br><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;kafka_2.13-2.7.0&#x2F;kafka-logs</span><br><span class="line"></span><br><span class="line"># 以后台进程方式启动kafka</span><br><span class="line">nohup &#x2F;usr&#x2F;local&#x2F;kafka_2.13-2.7.0&#x2F;bin&#x2F;kafka-server-start.sh &#x2F;usr&#x2F;local&#x2F;kafka_2.13-2.7.0&#x2F;config&#x2F;server.propertie &amp;</span><br><span class="line"></span><br><span class="line"># 查看服务是否启动正常</span><br><span class="line">ps -ef|grep kafka</span><br><span class="line">netstat -tunlp|grep 9092</span><br></pre></td></tr></table></figure>
<h2 id="Kafka常用命令"><a href="#Kafka常用命令" class="headerlink" title="Kafka常用命令"></a>Kafka常用命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 简单操作</span><br><span class="line"># （1）创建topic主题命令：（创建名为topic1的topic，分片数量为1，数据备份为1）</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --create --topic topic1 --partitions 1  --replication-factor 1</span><br><span class="line"># --zookeeper 为zk服务列表</span><br><span class="line"># --create 命令后 --topic 为创建topic 并指定topic name</span><br><span class="line"># --partitions 为指定分区数量</span><br><span class="line"># --replication-factor 为指定副本集数量</span><br><span class="line"></span><br><span class="line"># （2）查看topic列表命令</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --list</span><br><span class="line"></span><br><span class="line"># （3）kafka命令发送数据</span><br><span class="line">bin&#x2F;kafka-console-producer.sh --topic topic1 --bootstrap-server localhost:9092</span><br><span class="line"></span><br><span class="line"># （4）kafka命令接受数据</span><br><span class="line">bin&#x2F;kafka-console-consumer.sh --topic topic1 --from-beginning --bootstrap-server localhost:9092</span><br><span class="line"></span><br><span class="line"># （5）删除topic命令</span><br><span class="line">bin&#x2F;kafka-topics.sh --zookeeper localhost:2181 --delete --topic topic1</span><br><span class="line"></span><br><span class="line"># （6）kafka查看消费进度</span><br><span class="line">bin&#x2F;kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group app-log-group</span><br></pre></td></tr></table></figure>
<h2 id="Kafka与SpringBoot2-x整合"><a href="#Kafka与SpringBoot2-x整合" class="headerlink" title="Kafka与SpringBoot2.x整合"></a>Kafka与SpringBoot2.x整合</h2><img src="/2021/02/18/Kafka%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/Kafka-SpringBoot.png" class="">

<p><strong>聚合工程父pom：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.pd&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;&#x2F;packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;kafka-producer&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;kafka-consumer&lt;&#x2F;module&gt;</span><br><span class="line">    &lt;&#x2F;modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.kafka&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-kafka&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p><strong>生产者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;kafka-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.pd&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;kafka-producer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.properties配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.context-path&#x3D;&#x2F;producer</span><br><span class="line">server.port&#x3D;8001</span><br><span class="line"></span><br><span class="line">## Spring 整合 kafka</span><br><span class="line">spring.kafka.bootstrap-servers&#x3D;192.168.31.72:9092</span><br><span class="line">## kafka producer 发送消息失败时的一个重试的次数</span><br><span class="line">spring.kafka.producer.retries&#x3D;0</span><br><span class="line">## 批量发送数据的配置 (16K)</span><br><span class="line">spring.kafka.producer.batch-size&#x3D;16384</span><br><span class="line">## 设置kafka 生产者内存缓存区的大小（32M）</span><br><span class="line">spring.kafka.producer.buffer-memory&#x3D;33554432</span><br><span class="line">## kafka消息的序列化配置</span><br><span class="line">spring.kafka.producer.key-serializer&#x3D;org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">spring.kafka.producer.value-serializer&#x3D;org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line"></span><br><span class="line"># acks&#x3D;0 ： 生产者在成功写入消息之前不会等待任何来自服务器的响应。</span><br><span class="line"># acks&#x3D;1 ： 只要集群的首领节点收到消息，生产者就会收到一个来自服务器成功响应。</span><br><span class="line"># acks&#x3D;-1: 表示分区leader必须等待消息被成功写入到所有的ISR副本(同步副本)中才认为producer请求成功。这种方案提供最高的消息持久性保证，但是理论上吞吐率也是最差的。</span><br><span class="line"></span><br><span class="line">## 	这个是kafka生产端最重要的选项</span><br><span class="line">spring.kafka.producer.acks&#x3D;1</span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：编写KafkaProducerService生产端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.kafka.producer;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line">import org.springframework.kafka.support.SendResult;</span><br><span class="line">import org.springframework.lang.Nullable;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.util.concurrent.ListenableFuture;</span><br><span class="line">import org.springframework.util.concurrent.ListenableFutureCallback;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class KafkaProducerService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private KafkaTemplate&lt;String, Object&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    public void sendMessage(String topic, Object data) &#123;</span><br><span class="line"></span><br><span class="line">        ListenableFuture&lt;SendResult&lt;String, Object&gt;&gt; future &#x3D; kafkaTemplate.send(topic, data);</span><br><span class="line"></span><br><span class="line">        future.addCallback(new ListenableFutureCallback&lt;SendResult&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(@Nullable SendResult&lt;String, Object&gt; stringObjectSendResult) &#123;</span><br><span class="line">                log.info(&quot;发送消息成功： &quot; + stringObjectSendResult.toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(Throwable throwable) &#123;</span><br><span class="line">                log.error(&quot;发送消息失败：&quot; + throwable.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>消费者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;kafka-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.pd&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;kafka-consumer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.properties配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.context-path&#x3D;&#x2F;consumser</span><br><span class="line">server.port&#x3D;8002</span><br><span class="line"></span><br><span class="line">spring.kafka.bootstrap-servers&#x3D;192.168.31.72:9092</span><br><span class="line"></span><br><span class="line">## consumer 消息的签收机制：手工签收</span><br><span class="line">spring.kafka.consumer.enable-auto-commit&#x3D;false</span><br><span class="line">spring.kafka.listener.ack-mode&#x3D;manual</span><br><span class="line"># 该属性指定了消费者在读取一个没有偏移量的分区或者偏移量无效的情况下该作何处理：</span><br><span class="line"># latest（默认值）在偏移量无效的情况下，消费者将从最新的记录开始读取数据（在消费者启动之后生成的记录）</span><br><span class="line"># earliest ：在偏移量无效的情况下，消费者将从起始位置读取分区的记录</span><br><span class="line">spring.kafka.consumer.auto-offset-reset&#x3D;earliest</span><br><span class="line">## 序列化配置</span><br><span class="line">spring.kafka.consumer.key-deserializer&#x3D;org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">spring.kafka.consumer.value-deserializer&#x3D;org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line"></span><br><span class="line">spring.kafka.listener.concurrency&#x3D;5</span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：KafkaConsumerService消费端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.kafka.consumer;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.kafka.clients.consumer.Consumer;</span><br><span class="line">import org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line">import org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line">import org.springframework.kafka.support.Acknowledgment;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class KafkaConsumerService &#123;</span><br><span class="line"></span><br><span class="line">    @KafkaListener(groupId &#x3D; &quot;group01&quot;, topics &#x3D; &quot;topic01&quot;)</span><br><span class="line">    public void onMessage(ConsumerRecord&lt;String, Object&gt; record, Acknowledgment acknowledgment, Consumer&lt;?, ?&gt; consumer) &#123;</span><br><span class="line">        log.info(&quot;消费端接收消息: &#123;&#125;&quot;, record.value());</span><br><span class="line">        &#x2F;&#x2F;	收工签收机制</span><br><span class="line">        acknowledgment.acknowledge();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>生产端测试：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.kafka.producer.test;</span><br><span class="line"></span><br><span class="line">import com.pd.kafka.producer.KafkaProducerService;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ApplicationTests &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private KafkaProducerService kafkaProducerService;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void send() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">		String topic &#x3D; &quot;topic01&quot;;</span><br><span class="line">		for(int i&#x3D;0; i &lt; 10; i ++) &#123;</span><br><span class="line">			kafkaProducerService.sendMessage(topic, &quot;hello kafka&quot; + i);</span><br><span class="line">			Thread.sleep(5);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码地址 <a target="_blank" rel="noopener" href="https://github.com/dupeihui/kafka-springboot">https://github.com/dupeihui/kafka-springboot</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/RabbitMQ%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/17/RabbitMQ%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">RabbitMQ消息可靠性投递解决方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-17 23:24:14" itemprop="dateCreated datePublished" datetime="2021-02-17T23:24:14+08:00">2021-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:29:28" itemprop="dateModified" datetime="2021-02-21T23:29:28+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>谈到消息的可靠性投递，无法避免的，在实际的工作中会经常碰到，比如一些核心业务需要保障消息不丢失，接下来我们看一个可靠性投递的流程图，说明可靠性投递的概念：</p>
<img src="/2021/02/17/RabbitMQ%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/reliable-delivery.jpg" class="">

<ul>
<li><p>Step 1： 首先把消息信息(业务数据）存储到数据库中，紧接着，我们再把这个消息记录也存储到一张消息记录表里（或者另外一个同源数据库的消息记录表）</p>
</li>
<li><p>Step 2：发送消息到MQ Broker节点（采用confirm方式发送，会有异步的返回结果）</p>
</li>
<li><p>Step 3、4：生产者端接受MQ Broker节点返回的Confirm确认消息结果，然后进行更新消息记录表里的消息状态。比如默认Status = 0 当收到消息确认成功后，更新为1即可！</p>
</li>
<li><p>Step 5：但是在消息确认这个过程中可能由于网络闪断、MQ Broker端异常等原因导致 回送消息失败或者异常。这个时候就需要发送方（生产者）对消息进行可靠性投递了，保障消息不丢失，100%的投递成功！（有一种极限情况是闪断，Broker返回的成功确认消息，但是生产端由于网络闪断没收到，这个时候重新投递可能会造成消息重复，需要消费端去做幂等处理）所以我们需要有一个定时任务，（比如每5分钟拉取一下处于中间状态的消息，当然这个消息可以设置一个超时时间，比如超过1分钟 Status = 0 ，也就说明了1分钟这个时间窗口内，我们的消息没有被确认，那么会被定时任务拉取出来）</p>
</li>
<li><p>Step 6：接下来我们把中间状态的消息进行重新投递 retry send，继续发送消息到MQ ，当然也可能有多种原因导致发送失败</p>
</li>
<li><p>Step 7：我们可以采用设置最大努力尝试次数，比如投递了3次，还是失败，那么我们可以将最终状态设置为Status = 2 ，最后 交由人工解决处理此类问题（或者把消息转储到失败表中）</p>
</li>
</ul>
<p>接下来，我们使用SpringBoot2.x 实现这一可靠性投递策略：</p>
<ul>
<li>数据库库表结构：订单表和消息记录表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-- 表 order 订单结构</span><br><span class="line">CREATE TABLE IF NOT EXISTS &#96;t_order&#96; (</span><br><span class="line">  &#96;id&#96; varchar(128) NOT NULL, -- 订单ID</span><br><span class="line">  &#96;name&#96; varchar(128), -- 订单名称 其他业务熟悉忽略</span><br><span class="line">  &#96;message_id&#96; varchar(128) NOT NULL, -- 消息唯一ID</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- 表 broker_message_log 消息记录结构</span><br><span class="line">CREATE TABLE IF NOT EXISTS &#96;broker_message_log&#96; (</span><br><span class="line">  &#96;message_id&#96; varchar(128) NOT NULL, -- 消息唯一ID</span><br><span class="line">  &#96;message&#96; varchar(4000) DEFAULT NULL, -- 消息内容</span><br><span class="line">  &#96;try_count&#96; int(4) DEFAULT &#39;0&#39;, -- 重试次数</span><br><span class="line">  &#96;status&#96; varchar(10) DEFAULT &#39;&#39;, -- 消息投递状态  0 投递中 1 投递成功   2 投递失败</span><br><span class="line">  &#96;next_retry&#96; timestamp DEFAULT CURRENT_TIMESTAMP,  -- 下一次重试时间 或 超时时间</span><br><span class="line">  &#96;create_time&#96; timestamp DEFAULT CURRENT_TIMESTAMP, -- 创建时间</span><br><span class="line">  &#96;update_time&#96; timestamp DEFAULT CURRENT_TIMESTAMP, -- 更新时间</span><br><span class="line">  PRIMARY KEY (&#96;message_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>
<ul>
<li>整合SpringBoot 实现生产端代码如下：pom.xml配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rabbitmq-reliable-delivery&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;&#x2F;packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.1&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;tk.mybatis&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mapper-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.0&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.24&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-io&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-io&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.4&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.26&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;javax.servlet-api&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;log4j&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.17&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;&#x2F;optional&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>application.properties配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">spring.rabbitmq.addresses&#x3D;192.168.31.70</span><br><span class="line">spring.rabbitmq.username&#x3D;guest</span><br><span class="line">spring.rabbitmq.password&#x3D;guest</span><br><span class="line">spring.rabbitmq.virtual-host&#x3D;&#x2F;</span><br><span class="line">spring.rabbitmq.connection-timeout&#x3D;15000</span><br><span class="line"></span><br><span class="line">spring.rabbitmq.publisher-confirms&#x3D;true</span><br><span class="line">spring.rabbitmq.publisher-returns&#x3D;true</span><br><span class="line">spring.rabbitmq.template.mandatory&#x3D;true</span><br><span class="line"></span><br><span class="line">server.servlet.context-path&#x3D;&#x2F;</span><br><span class="line">server.port&#x3D;8168</span><br><span class="line"></span><br><span class="line">spring.http.encoding.charset&#x3D;UTF-8</span><br><span class="line">spring.jackson.date-format&#x3D;yyyy-MM-dd HH:mm:ss</span><br><span class="line">spring.jackson.time-zone&#x3D;GMT+8</span><br><span class="line">spring.jackson.default-property-inclusion&#x3D;non_null</span><br><span class="line"></span><br><span class="line">spring.datasource.type&#x3D;com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">spring.datasource.url&#x3D;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;rabbitmq_test?characterEncoding&#x3D;UTF-8&amp;autoReconnect&#x3D;true&amp;zeroDateTimeBehavior&#x3D;convertToNull&amp;useUnicode&#x3D;true</span><br><span class="line">spring.datasource.driver-class-name&#x3D;com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.username&#x3D;root</span><br><span class="line">spring.datasource.password&#x3D;root</span><br><span class="line"></span><br><span class="line">mybatis.type-aliases-package&#x3D;com.pd.springboot</span><br><span class="line">mybatis.mapper-locations&#x3D;classpath:com&#x2F;pd&#x2F;springboot&#x2F;mapping&#x2F;*.xml</span><br><span class="line"></span><br><span class="line">logging.level.tk.mybatis&#x3D;TRACE</span><br></pre></td></tr></table></figure>
<ul>
<li>数据源druid.properties配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">## 下面为连接池的补充设置，应用到上面所有数据源中</span><br><span class="line"># 初始化大小，最小，最大</span><br><span class="line">druid.initialSize&#x3D;5</span><br><span class="line">druid.minIdle&#x3D;10</span><br><span class="line">druid.maxActive&#x3D;300</span><br><span class="line"></span><br><span class="line">#配置获取连接等待超时的时间</span><br><span class="line">druid.maxWait&#x3D;60000</span><br><span class="line"></span><br><span class="line">#配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br><span class="line">druid.timeBetweenEvictionRunsMillis&#x3D;60000</span><br><span class="line"></span><br><span class="line">#配置一个连接在池中最小生存的时间，单位是毫秒</span><br><span class="line">druid.minEvictableIdleTimeMillis&#x3D;300000</span><br><span class="line">druid.validationQuery&#x3D;SELECT 1 FROM DUAL</span><br><span class="line">druid.testWhileIdle&#x3D;true</span><br><span class="line">druid.testOnBorrow&#x3D;false</span><br><span class="line">druid.testOnReturn&#x3D;false</span><br><span class="line"></span><br><span class="line">#打开PSCache，并且指定每个连接上PSCache的大小</span><br><span class="line">druid.poolPreparedStatements&#x3D;true</span><br><span class="line">druid.maxPoolPreparedStatementPerConnectionSize&#x3D;20</span><br><span class="line"></span><br><span class="line">#配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#39;wall&#39;用于防火墙</span><br><span class="line">druid.filters&#x3D;stat,wall,log4j</span><br><span class="line"></span><br><span class="line">#通过connectProperties属性来打开mergeSql功能；慢SQL记录</span><br><span class="line">druid.connectionProperties&#x3D;druid.stat.mergeSql&#x3D;true;druid.stat.slowSqlMillis&#x3D;5000</span><br><span class="line"></span><br><span class="line">#合并多个DruidDataSource的监控数据</span><br><span class="line">druid.useGlobalDataSourceStat&#x3D;true</span><br></pre></td></tr></table></figure>
<ul>
<li>实体对象：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.entity;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">public class BrokerMessageLog &#123;</span><br><span class="line"></span><br><span class="line">    private String messageId;</span><br><span class="line"></span><br><span class="line">    private String message;</span><br><span class="line"></span><br><span class="line">    private Integer tryCount;</span><br><span class="line"></span><br><span class="line">    private String status;</span><br><span class="line"></span><br><span class="line">    private Date nextRetry;</span><br><span class="line"></span><br><span class="line">    private Date createTime;</span><br><span class="line"></span><br><span class="line">    private Date updateTime;</span><br><span class="line"></span><br><span class="line">    public String getMessageId() &#123;</span><br><span class="line">        return messageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessageId(String messageId) &#123;</span><br><span class="line">        this.messageId &#x3D; messageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMessage() &#123;</span><br><span class="line">        return message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessage(String message) &#123;</span><br><span class="line">        this.message &#x3D; message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getTryCount() &#123;</span><br><span class="line">        return tryCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTryCount(Integer tryCount) &#123;</span><br><span class="line">        this.tryCount &#x3D; tryCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getStatus() &#123;</span><br><span class="line">        return status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setStatus(String status) &#123;</span><br><span class="line">        this.status &#x3D; status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Date getNextRetry() &#123;</span><br><span class="line">        return nextRetry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNextRetry(Date nextRetry) &#123;</span><br><span class="line">        this.nextRetry &#x3D; nextRetry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Date getCreateTime() &#123;</span><br><span class="line">        return createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCreateTime(Date createTime) &#123;</span><br><span class="line">        this.createTime &#x3D; createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Date getUpdateTime() &#123;</span><br><span class="line">        return updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUpdateTime(Date updateTime) &#123;</span><br><span class="line">        this.updateTime &#x3D; updateTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.entity;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class Order implements Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID &#x3D; -3976637520034477402L;</span><br><span class="line"></span><br><span class="line">    private String id;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    private String messageId;</span><br><span class="line"></span><br><span class="line">    public String getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(String id) &#123;</span><br><span class="line">        this.id &#x3D; id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMessageId() &#123;</span><br><span class="line">        return messageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessageId(String messageId) &#123;</span><br><span class="line">        this.messageId &#x3D; messageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>数据库连接池代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.database;</span><br><span class="line"></span><br><span class="line">import java.sql.SQLException;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;</span><br><span class="line">import org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line">import org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line">import org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableTransactionManagement</span><br><span class="line">public class DruidDataSourceConfig &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(DruidDataSourceConfig.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DruidDataSourceSettings druidSettings;</span><br><span class="line"></span><br><span class="line">    public static String DRIVER_CLASSNAME ;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public static PropertySourcesPlaceholderConfigurer propertyConfigure()&#123;</span><br><span class="line">        return new PropertySourcesPlaceholderConfigurer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public DataSource dataSource() throws SQLException &#123;</span><br><span class="line">        DruidDataSource ds &#x3D; new DruidDataSource();</span><br><span class="line">        ds.setDriverClassName(druidSettings.getDriverClassName());</span><br><span class="line">        DRIVER_CLASSNAME &#x3D; druidSettings.getDriverClassName();</span><br><span class="line">        ds.setUrl(druidSettings.getUrl());</span><br><span class="line">        ds.setUsername(druidSettings.getUsername());</span><br><span class="line">        ds.setPassword(druidSettings.getPassword());</span><br><span class="line">        ds.setInitialSize(druidSettings.getInitialSize());</span><br><span class="line">        ds.setMinIdle(druidSettings.getMinIdle());</span><br><span class="line">        ds.setMaxActive(druidSettings.getMaxActive());</span><br><span class="line">        ds.setTimeBetweenEvictionRunsMillis(druidSettings.getTimeBetweenEvictionRunsMillis());</span><br><span class="line">        ds.setMinEvictableIdleTimeMillis(druidSettings.getMinEvictableIdleTimeMillis());</span><br><span class="line">        ds.setValidationQuery(druidSettings.getValidationQuery());</span><br><span class="line">        ds.setTestWhileIdle(druidSettings.isTestWhileIdle());</span><br><span class="line">        ds.setTestOnBorrow(druidSettings.isTestOnBorrow());</span><br><span class="line">        ds.setTestOnReturn(druidSettings.isTestOnReturn());</span><br><span class="line">        ds.setPoolPreparedStatements(druidSettings.isPoolPreparedStatements());</span><br><span class="line">        ds.setMaxPoolPreparedStatementPerConnectionSize(druidSettings.getMaxPoolPreparedStatementPerConnectionSize());</span><br><span class="line">        ds.setFilters(druidSettings.getFilters());</span><br><span class="line">        ds.setConnectionProperties(druidSettings.getConnectionProperties());</span><br><span class="line">        logger.info(&quot; druid datasource config : &#123;&#125; &quot;, ds);</span><br><span class="line">        return ds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PlatformTransactionManager transactionManager() throws Exception &#123;</span><br><span class="line">        DataSourceTransactionManager txManager &#x3D; new DataSourceTransactionManager();</span><br><span class="line">        txManager.setDataSource(dataSource());</span><br><span class="line">        return txManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.database;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.PropertySource;</span><br><span class="line">import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@ConfigurationProperties(prefix&#x3D;&quot;spring.datasource&quot;)</span><br><span class="line">@PropertySource(&quot;classpath:druid.properties&quot;)</span><br><span class="line">public class DruidDataSourceSettings &#123;</span><br><span class="line"></span><br><span class="line">    private String driverClassName;</span><br><span class="line">    private String url;</span><br><span class="line">    private String username;</span><br><span class="line">    private String password;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.initialSize&#125;&quot;)</span><br><span class="line">    private int initialSize;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.minIdle&#125;&quot;)</span><br><span class="line">    private int minIdle;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.maxActive&#125;&quot;)</span><br><span class="line">    private int maxActive;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.timeBetweenEvictionRunsMillis&#125;&quot;)</span><br><span class="line">    private long timeBetweenEvictionRunsMillis;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.minEvictableIdleTimeMillis&#125;&quot;)</span><br><span class="line">    private long minEvictableIdleTimeMillis;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.validationQuery&#125;&quot;)</span><br><span class="line">    private String validationQuery;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.testWhileIdle&#125;&quot;)</span><br><span class="line">    private boolean testWhileIdle;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.testOnBorrow&#125;&quot;)</span><br><span class="line">    private boolean testOnBorrow;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.testOnReturn&#125;&quot;)</span><br><span class="line">    private boolean testOnReturn;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.poolPreparedStatements&#125;&quot;)</span><br><span class="line">    private boolean poolPreparedStatements;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.maxPoolPreparedStatementPerConnectionSize&#125;&quot;)</span><br><span class="line">    private int maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.filters&#125;&quot;)</span><br><span class="line">    private String filters;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;druid.connectionProperties&#125;&quot;)</span><br><span class="line">    private String connectionProperties;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public static PropertySourcesPlaceholderConfigurer properdtyConfigure()&#123;</span><br><span class="line">        return new PropertySourcesPlaceholderConfigurer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getDriverClassName() &#123;</span><br><span class="line">        return driverClassName;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setDriverClassName(String driverClassName) &#123;</span><br><span class="line">        this.driverClassName &#x3D; driverClassName;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUrl() &#123;</span><br><span class="line">        return url;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUrl(String url) &#123;</span><br><span class="line">        this.url &#x3D; url;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsername(String username) &#123;</span><br><span class="line">        this.username &#x3D; username;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getPassword() &#123;</span><br><span class="line">        return password;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setPassword(String password) &#123;</span><br><span class="line">        this.password &#x3D; password;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getInitialSize() &#123;</span><br><span class="line">        return initialSize;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setInitialSize(int initialSize) &#123;</span><br><span class="line">        this.initialSize &#x3D; initialSize;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getMinIdle() &#123;</span><br><span class="line">        return minIdle;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMinIdle(int minIdle) &#123;</span><br><span class="line">        this.minIdle &#x3D; minIdle;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getMaxActive() &#123;</span><br><span class="line">        return maxActive;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMaxActive(int maxActive) &#123;</span><br><span class="line">        this.maxActive &#x3D; maxActive;</span><br><span class="line">    &#125;</span><br><span class="line">    public long getTimeBetweenEvictionRunsMillis() &#123;</span><br><span class="line">        return timeBetweenEvictionRunsMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setTimeBetweenEvictionRunsMillis(long timeBetweenEvictionRunsMillis) &#123;</span><br><span class="line">        this.timeBetweenEvictionRunsMillis &#x3D; timeBetweenEvictionRunsMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    public long getMinEvictableIdleTimeMillis() &#123;</span><br><span class="line">        return minEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMinEvictableIdleTimeMillis(long minEvictableIdleTimeMillis) &#123;</span><br><span class="line">        this.minEvictableIdleTimeMillis &#x3D; minEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getValidationQuery() &#123;</span><br><span class="line">        return validationQuery;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setValidationQuery(String validationQuery) &#123;</span><br><span class="line">        this.validationQuery &#x3D; validationQuery;</span><br><span class="line">    &#125;</span><br><span class="line">    public boolean isTestWhileIdle() &#123;</span><br><span class="line">        return testWhileIdle;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setTestWhileIdle(boolean testWhileIdle) &#123;</span><br><span class="line">        this.testWhileIdle &#x3D; testWhileIdle;</span><br><span class="line">    &#125;</span><br><span class="line">    public boolean isTestOnBorrow() &#123;</span><br><span class="line">        return testOnBorrow;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setTestOnBorrow(boolean testOnBorrow) &#123;</span><br><span class="line">        this.testOnBorrow &#x3D; testOnBorrow;</span><br><span class="line">    &#125;</span><br><span class="line">    public boolean isTestOnReturn() &#123;</span><br><span class="line">        return testOnReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setTestOnReturn(boolean testOnReturn) &#123;</span><br><span class="line">        this.testOnReturn &#x3D; testOnReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    public boolean isPoolPreparedStatements() &#123;</span><br><span class="line">        return poolPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setPoolPreparedStatements(boolean poolPreparedStatements) &#123;</span><br><span class="line">        this.poolPreparedStatements &#x3D; poolPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getMaxPoolPreparedStatementPerConnectionSize() &#123;</span><br><span class="line">        return maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMaxPoolPreparedStatementPerConnectionSize(</span><br><span class="line">            int maxPoolPreparedStatementPerConnectionSize) &#123;</span><br><span class="line">        this.maxPoolPreparedStatementPerConnectionSize &#x3D; maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getFilters() &#123;</span><br><span class="line">        return filters;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setFilters(String filters) &#123;</span><br><span class="line">        this.filters &#x3D; filters;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getConnectionProperties() &#123;</span><br><span class="line">        return connectionProperties;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setConnectionProperties(String connectionProperties) &#123;</span><br><span class="line">        this.connectionProperties &#x3D; connectionProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.database;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line">import org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line">import org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class MybatisDataSourceConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    @Bean(name&#x3D;&quot;sqlSessionFactory&quot;)</span><br><span class="line">    public SqlSessionFactory sqlSessionFactoryBean() &#123;</span><br><span class="line">        SqlSessionFactoryBean bean &#x3D; new SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        &#x2F;&#x2F; 添加XML目录</span><br><span class="line">        ResourcePatternResolver resolver &#x3D; new PathMatchingResourcePatternResolver();</span><br><span class="line">        try &#123;</span><br><span class="line">            bean.setMapperLocations(resolver.getResources(&quot;classpath:mapper&#x2F;*.xml&quot;));</span><br><span class="line">            SqlSessionFactory sqlSessionFactory &#x3D; bean.getObject();</span><br><span class="line">            sqlSessionFactory.getConfiguration().setCacheEnabled(Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">            return sqlSessionFactory;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">        return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.database;</span><br><span class="line">import org.mybatis.spring.mapper.MapperScannerConfigurer;</span><br><span class="line">import org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@AutoConfigureAfter(MybatisDataSourceConfig.class)</span><br><span class="line">public class MybatisMapperScanerConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public MapperScannerConfigurer mapperScannerConfigurer() &#123;</span><br><span class="line">        MapperScannerConfigurer mapperScannerConfigurer &#x3D; new MapperScannerConfigurer();</span><br><span class="line">        mapperScannerConfigurer.setSqlSessionFactoryBeanName(&quot;sqlSessionFactory&quot;);</span><br><span class="line">        mapperScannerConfigurer.setBasePackage(&quot;com.pd.springboot.mapper&quot;);</span><br><span class="line">        return mapperScannerConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定时任务配置代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.task;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.scheduling.annotation.EnableScheduling;</span><br><span class="line">import org.springframework.scheduling.annotation.SchedulingConfigurer;</span><br><span class="line">import org.springframework.scheduling.config.ScheduledTaskRegistrar;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Executor;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableScheduling</span><br><span class="line">public class TaskScheduleConfig implements SchedulingConfigurer &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configureTasks(ScheduledTaskRegistrar taskRegistrar) &#123;</span><br><span class="line">        taskRegistrar.setScheduler(taskScheduler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public Executor taskScheduler()&#123;</span><br><span class="line">        return Executors.newScheduledThreadPool(100);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>常量类：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.constant;</span><br><span class="line"></span><br><span class="line">public final class Constants &#123;</span><br><span class="line"></span><br><span class="line">    public static final String ORDER_SENDING &#x3D; &quot;0&quot;; &#x2F;&#x2F;发送中</span><br><span class="line"></span><br><span class="line">    public static final String ORDER_SEND_SUCCESS &#x3D; &quot;1&quot;; &#x2F;&#x2F;成功</span><br><span class="line"></span><br><span class="line">    public static final String ORDER_SEND_FAILURE &#x3D; &quot;2&quot;; &#x2F;&#x2F;失败</span><br><span class="line"></span><br><span class="line">    public static final int ORDER_TIMEOUT &#x3D; 1; &#x2F;*分钟超时单位：min*&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>消息记录核心业务表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.mapper;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line">import org.apache.ibatis.annotations.Param;</span><br><span class="line">import com.pd.springboot.entity.BrokerMessageLog;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface BrokerMessageLogMapper &#123;</span><br><span class="line"></span><br><span class="line">    int insert(BrokerMessageLog brokerMessageLog);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 查询消息状态为0(发送中) 且已经超时的消息集合</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    List&lt;BrokerMessageLog&gt; query4StatusAndTimeoutMessage();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 重新发送统计count发送次数 +1</span><br><span class="line">     * @param messageId</span><br><span class="line">     * @param updateTime</span><br><span class="line">     *&#x2F;</span><br><span class="line">    void update4ReSend(@Param(&quot;messageId&quot;)String messageId, @Param(&quot;updateTime&quot;)Date updateTime);</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 更新最终消息发送结果 成功 or 失败</span><br><span class="line">     * @param messageId</span><br><span class="line">     * @param status</span><br><span class="line">     * @param updateTime</span><br><span class="line">     *&#x2F;</span><br><span class="line">    void changeBrokerMessageLogStatus(@Param(&quot;messageId&quot;)String messageId, @Param(&quot;status&quot;)String status, @Param(&quot;updateTime&quot;)Date updateTime);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对应的SQL代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot; &gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;com.pd.springboot.mapper.BrokerMessageLogMapper&quot;&gt;</span><br><span class="line">    &lt;resultMap id&#x3D;&quot;BaseResultMap&quot; type&#x3D;&quot;com.pd.springboot.entity.BrokerMessageLog&quot; &gt;</span><br><span class="line">        &lt;id column&#x3D;&quot;message_id&quot; property&#x3D;&quot;messageId&quot; jdbcType&#x3D;&quot;VARCHAR&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;message&quot; property&#x3D;&quot;message&quot; jdbcType&#x3D;&quot;VARCHAR&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;try_count&quot; property&#x3D;&quot;tryCount&quot; jdbcType&#x3D;&quot;INTEGER&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;status&quot; property&#x3D;&quot;status&quot; jdbcType&#x3D;&quot;VARCHAR&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;next_retry&quot; property&#x3D;&quot;nextRetry&quot; jdbcType&#x3D;&quot;TIMESTAMP&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;create_time&quot; property&#x3D;&quot;createTime&quot; jdbcType&#x3D;&quot;TIMESTAMP&quot; &#x2F;&gt;</span><br><span class="line">        &lt;result column&#x3D;&quot;update_time&quot; property&#x3D;&quot;updateTime&quot; jdbcType&#x3D;&quot;TIMESTAMP&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;resultMap&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id&#x3D;&quot;insert&quot; parameterType&#x3D;&quot;com.pd.springboot.entity.BrokerMessageLog&quot;&gt;</span><br><span class="line">        insert into broker_message_log (message_id, message,</span><br><span class="line">        status, next_retry, create_time,</span><br><span class="line">        update_time)</span><br><span class="line">        values (#&#123;messageId,jdbcType&#x3D;VARCHAR&#125;, #&#123;message,jdbcType&#x3D;VARCHAR&#125;,</span><br><span class="line">        #&#123;status,jdbcType&#x3D;VARCHAR&#125;, #&#123;nextRetry,jdbcType&#x3D;TIMESTAMP&#125;, #&#123;createTime,jdbcType&#x3D;TIMESTAMP&#125;,</span><br><span class="line">        #&#123;updateTime,jdbcType&#x3D;TIMESTAMP&#125;)</span><br><span class="line">    &lt;&#x2F;insert&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id&#x3D;&quot;query4StatusAndTimeoutMessage&quot; resultMap&#x3D;&quot;BaseResultMap&quot;&gt;</span><br><span class="line">        &lt;![CDATA[</span><br><span class="line">          select message_id, message, try_count, status, next_retry, create_time, update_time</span><br><span class="line">              from broker_message_log bml</span><br><span class="line">              where status &#x3D; &#39;0&#39;</span><br><span class="line">              and next_retry &lt;&#x3D; sysdate()</span><br><span class="line">          ]]&gt;</span><br><span class="line">    &lt;&#x2F;select&gt;</span><br><span class="line"></span><br><span class="line">    &lt;update id&#x3D;&quot;update4ReSend&quot; &gt;</span><br><span class="line">        update broker_message_log bml</span><br><span class="line">        set bml.try_count &#x3D; bml.try_count + 1,</span><br><span class="line">        bml.update_time &#x3D; #&#123;updateTime, jdbcType&#x3D;TIMESTAMP&#125;</span><br><span class="line">        where bml.message_id &#x3D; #&#123;messageId,jdbcType&#x3D;VARCHAR&#125;</span><br><span class="line">    &lt;&#x2F;update&gt;</span><br><span class="line"></span><br><span class="line">    &lt;update id&#x3D;&quot;changeBrokerMessageLogStatus&quot; &gt;</span><br><span class="line">        update broker_message_log bml</span><br><span class="line">        set bml.status &#x3D; #&#123;status,jdbcType&#x3D;VARCHAR&#125;,</span><br><span class="line">        bml.update_time &#x3D; #&#123;updateTime, jdbcType&#x3D;TIMESTAMP&#125;</span><br><span class="line">        where bml.message_id &#x3D; #&#123;messageId,jdbcType&#x3D;VARCHAR&#125;</span><br><span class="line">    &lt;&#x2F;update&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>核心发送代码：OrderService</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.service;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import org.apache.commons.lang3.time.DateUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import com.pd.springboot.constant.Constants;</span><br><span class="line">import com.pd.springboot.entity.BrokerMessageLog;</span><br><span class="line">import com.pd.springboot.entity.Order;</span><br><span class="line">import com.pd.springboot.mapper.BrokerMessageLogMapper;</span><br><span class="line">import com.pd.springboot.mapper.OrderMapper;</span><br><span class="line">import com.pd.springboot.produer.RabbitOrderSender;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class OrderService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private BrokerMessageLogMapper brokerMessageLogMapper;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitOrderSender rabbitOrderSender;</span><br><span class="line"></span><br><span class="line">    public void createOrder(Order order) throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 使用当前时间当做订单创建时间（为了模拟一下简化）</span><br><span class="line">        Date orderTime &#x3D; new Date();</span><br><span class="line">        &#x2F;&#x2F; 插入业务数据</span><br><span class="line">        orderMapper.insert(order);</span><br><span class="line">        &#x2F;&#x2F; 插入消息记录表数据</span><br><span class="line">        BrokerMessageLog brokerMessageLog &#x3D; new BrokerMessageLog();</span><br><span class="line">        &#x2F;&#x2F; 消息唯一ID</span><br><span class="line">        brokerMessageLog.setMessageId(order.getMessageId());</span><br><span class="line">        &#x2F;&#x2F; 保存消息整体 转为JSON 格式存储入库</span><br><span class="line">        brokerMessageLog.setMessage(JSONObject.toJSONString(order));</span><br><span class="line">        &#x2F;&#x2F; 设置消息状态为0 表示发送中</span><br><span class="line">        brokerMessageLog.setStatus(&quot;0&quot;);</span><br><span class="line">        &#x2F;&#x2F; 设置消息未确认超时时间窗口为 一分钟</span><br><span class="line">        brokerMessageLog.setNextRetry(DateUtils.addMinutes(orderTime, Constants.ORDER_TIMEOUT));</span><br><span class="line">        brokerMessageLog.setCreateTime(new Date());</span><br><span class="line">        brokerMessageLog.setUpdateTime(new Date());</span><br><span class="line">        brokerMessageLogMapper.insert(brokerMessageLog);</span><br><span class="line">        &#x2F;&#x2F; 发送消息</span><br><span class="line">        rabbitOrderSender.sendOrder(order);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MQ消息发送核心代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.produer;</span><br><span class="line"></span><br><span class="line">import com.pd.springboot.constant.Constants;</span><br><span class="line">import com.pd.springboot.entity.Order;</span><br><span class="line">import com.pd.springboot.mapper.BrokerMessageLogMapper;</span><br><span class="line">import org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.lang.Nullable;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RabbitOrderSender &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private BrokerMessageLogMapper brokerMessageLogMapper;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;回调函数：confirm确认</span><br><span class="line">    final RabbitTemplate.ConfirmCallback confirmCallback &#x3D; new RabbitTemplate.ConfirmCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void confirm(@Nullable CorrelationData correlationData, boolean ack, @Nullable String cause) &#123;</span><br><span class="line">            System.out.println(&quot;correlationData:&quot; + correlationData);</span><br><span class="line">            String messageId &#x3D; correlationData.getId();</span><br><span class="line">            if(ack) &#123;</span><br><span class="line">                brokerMessageLogMapper.changeBrokerMessageLogStatus(messageId, Constants.ORDER_SEND_SUCCESS, new Date());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F;失败则进行具体的后续操作：重试或者补偿等手段</span><br><span class="line">                System.out.println(&quot;异常处理......&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;发送消息方法调用：构建自定义对象消息</span><br><span class="line">    public void sendOrder(Order order)throws Exception&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(confirmCallback);</span><br><span class="line">        &#x2F;&#x2F;消息唯一Id</span><br><span class="line">        CorrelationData correlationData &#x3D; new CorrelationData(order.getMessageId());</span><br><span class="line">        rabbitTemplate.convertAndSend(&quot;order-exchange&quot;,&quot;order.abc&quot;,order,correlationData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>消息重试、最大努力尝试策略（定时任务）：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.config.task;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import com.pd.springboot.constant.Constants;</span><br><span class="line">import com.pd.springboot.entity.BrokerMessageLog;</span><br><span class="line">import com.pd.springboot.entity.Order;</span><br><span class="line">import com.pd.springboot.mapper.BrokerMessageLogMapper;</span><br><span class="line">import com.pd.springboot.produer.RabbitOrderSender;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RetryMessageTasker &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitOrderSender rabbitOrderSender;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private BrokerMessageLogMapper brokerMessageLogMapper;</span><br><span class="line"></span><br><span class="line">    @Scheduled(initialDelay &#x3D; 5000, fixedDelay &#x3D; 10000)</span><br><span class="line">    public void reSend()&#123;</span><br><span class="line">        &#x2F;&#x2F;pull status &#x3D; 0 and timeout message</span><br><span class="line">        List&lt;BrokerMessageLog&gt; list &#x3D; brokerMessageLogMapper.query4StatusAndTimeoutMessage();</span><br><span class="line">        list.forEach(messageLog -&gt; &#123;</span><br><span class="line">            if(messageLog.getTryCount() &gt;&#x3D; 3)&#123;</span><br><span class="line">                &#x2F;&#x2F;update fail message</span><br><span class="line">                brokerMessageLogMapper.changeBrokerMessageLogStatus(messageLog.getMessageId(), Constants.ORDER_SEND_FAILURE, new Date());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; resend</span><br><span class="line">                brokerMessageLogMapper.update4ReSend(messageLog.getMessageId(),  new Date());</span><br><span class="line">                Order reSendOrder &#x3D; JSONObject.parseObject(messageLog.getMessage(), Order.class);</span><br><span class="line">                try &#123;</span><br><span class="line">                    rabbitOrderSender.sendOrder(reSendOrder);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    System.err.println(&quot;-----------异常处理-----------&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>测试发送订单</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.pd.springboot.test;</span><br><span class="line"></span><br><span class="line">import com.pd.springboot.entity.Order;</span><br><span class="line">import com.pd.springboot.produer.RabbitOrderSender;</span><br><span class="line">import com.pd.springboot.service.OrderService;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line">import java.util.UUID;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ApplicationTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitOrderSender rabbitOrderSender;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testSender1() throws Exception&#123;</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setId(&quot;2021021300000001&quot;);</span><br><span class="line">        order.setName(&quot;测试订单&quot;);</span><br><span class="line">        order.setMessageId(System.currentTimeMillis() + &quot;$&quot; + UUID.randomUUID().toString());</span><br><span class="line">        rabbitOrderSender.sendOrder(order);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testCreateOrder1() throws Exception &#123;</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setId(&quot;2021021300000007&quot;);</span><br><span class="line">        order.setName(&quot;测试订单&quot;);</span><br><span class="line">        order.setMessageId(System.currentTimeMillis() + &quot;$&quot; + UUID.randomUUID().toString());</span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码地址 <a target="_blank" rel="noopener" href="https://github.com/dupeihui/rabbitmq-reliable-delivery">https://github.com/dupeihui/rabbitmq-reliable-delivery</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/RabbitMQ%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/17/RabbitMQ%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%B8%8ESpringBoot2-x%E6%95%B4%E5%90%88/" class="post-title-link" itemprop="url">RabbitMQ快速安装以及与SpringBoot2.x整合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-17 23:19:42" itemprop="dateCreated datePublished" datetime="2021-02-17T23:19:42+08:00">2021-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:22:25" itemprop="dateModified" datetime="2021-02-21T23:22:25+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="快速安装单机版RabbitMQ"><a href="#快速安装单机版RabbitMQ" class="headerlink" title="快速安装单机版RabbitMQ"></a>快速安装单机版RabbitMQ</h2><ul>
<li>准备一台Linux虚拟机（CentOS 7）</li>
<li>进入安装：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 1.首先在Linux上进行一些软件的准备工作，安装一些基础的依赖包</span><br><span class="line">yum install build-essential  openssl openssl-devel unixODBC unixODBC-devel make gcc gcc-c++ kernel-devel</span><br><span class="line"></span><br><span class="line"># 2.下载RabbitMQ所需软件包（这里使用的是RabbitMQ3.6.5稳定版本）</span><br><span class="line">wget https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;releases&#x2F;erlang&#x2F;erlang-18.3-1.el7.centos.x86_64.rpm</span><br><span class="line">wget https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;releases&#x2F;rabbitmq-server&#x2F;v3.6.5&#x2F;rabbitmq-server-3.6.5-1.noarch.rpm</span><br><span class="line"></span><br><span class="line"># 3.安装服务命令</span><br><span class="line">rpm -ivh erlang-18.3-1.el7.centos.x86_64.rpm</span><br><span class="line">rpm -ivh rabbitmq-server-3.6.5-1.noarch.rpm</span><br><span class="line"></span><br><span class="line"># 4.修改用户登录与连接心跳检测</span><br><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;rabbitmq&#x2F;lib&#x2F;rabbitmq_server-3.6.5&#x2F;ebin&#x2F;rabbit.app</span><br><span class="line">修改点1:loopback_users中的&lt;&lt;&quot;guest&quot;&gt;&gt;,只保留guest（用于用户登录）</span><br><span class="line">修改点2:heartbeat 为10（用于心跳连接）</span><br><span class="line"></span><br><span class="line"># 5.安装管理插件和启动服务</span><br><span class="line"></span><br><span class="line"># 5.1 首先启动服务（后面 | 包含了停止、查看状态以及重启的命令）</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;rabbitmq-server start | stop | status | restart</span><br><span class="line"></span><br><span class="line"># 5.2 查看服务有没有启动（5672是RabbitMQ的默认端口）</span><br><span class="line">lsof -i:5672</span><br><span class="line"></span><br><span class="line"># 5.3 安装管理插件</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"></span><br><span class="line"># 5.4 查看管理端口有没有占用</span><br><span class="line">lsof -i:15672  或者  netstat -tunlp | grep 15672</span><br><span class="line"></span><br><span class="line"># 6.访问页面，输入用户名密码均为：guest</span><br><span class="line"># http:&#x2F;&#x2F;你的ip地址:15672&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="RabbitMQ与SpringBoot2-x整合"><a href="#RabbitMQ与SpringBoot2-x整合" class="headerlink" title="RabbitMQ与SpringBoot2.x整合"></a>RabbitMQ与SpringBoot2.x整合</h2><p><strong>聚合工程父pom：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;&#x2F;packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;rabbitmq-consumer&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;rabbitmq-producer&lt;&#x2F;module&gt;</span><br><span class="line">    &lt;&#x2F;modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p><strong>生产者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;rabbitmq-producer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.yml配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8001</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    addresses: 192.168.31.62:5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br><span class="line">    virtual-host: &#x2F;</span><br><span class="line">    connection-timeout: 15000</span><br><span class="line">    publisher-confirms: true    # confirm模式</span><br><span class="line">    publisher-returns: true     # return机制</span><br><span class="line">    template:</span><br><span class="line">      mandatory: true           # 与return机制结合配置次属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：编写RabbitSender生产端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.producer;</span><br><span class="line"></span><br><span class="line">import org.springframework.amqp.core.Message;</span><br><span class="line">import org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate.ConfirmCallback;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate.ReturnCallback;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.lang.Nullable;</span><br><span class="line">import org.springframework.messaging.MessageHeaders;</span><br><span class="line">import org.springframework.messaging.support.MessageBuilder;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RabbitMQSender &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;回调函数，confirm确认</span><br><span class="line">    final ConfirmCallback confirmCallback &#x3D; new ConfirmCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void confirm(@Nullable CorrelationData correlationData, boolean ack, @Nullable String cause) &#123;</span><br><span class="line">            System.out.println(&quot;correlationData: &quot; + correlationData);</span><br><span class="line">            System.out.println(&quot;ack: &quot; + ack);</span><br><span class="line">            if (!ack) &#123;</span><br><span class="line">                System.out.println(&quot;异常处理......&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;回调函数，return返回</span><br><span class="line">    final ReturnCallback returnCallback &#x3D; new ReturnCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) &#123;</span><br><span class="line">            System.out.println(&quot;exchange: &quot; + exchange + &quot;,routingKey: &quot; + routingKey +</span><br><span class="line">                                &quot;,replyCode: &quot; + replyCode + &quot;,replyText: &quot; + replyText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;发送消息方法调用：构建Message消息</span><br><span class="line">    public void send(Object message, Map&lt;String, Object&gt; properties) throws Exception &#123;</span><br><span class="line">        MessageHeaders mhs &#x3D; new MessageHeaders(properties);</span><br><span class="line">        org.springframework.messaging.Message msg &#x3D; MessageBuilder.createMessage(message, mhs);</span><br><span class="line">        rabbitTemplate.setConfirmCallback(confirmCallback);</span><br><span class="line">        rabbitTemplate.setReturnCallback(returnCallback);</span><br><span class="line">        CorrelationData correlationData &#x3D; new CorrelationData(&quot;1234567890&quot;);</span><br><span class="line">        rabbitTemplate.convertAndSend(&quot;exchange-1&quot;, &quot;springboot.abc&quot;, msg, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>消费者端：</strong></p>
<ul>
<li>第一步：pom.xml配置如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;rabbitmq-springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.rabbitmq&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;rabbitmq-consumer&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：application.yml配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    addresses: 192.168.31.62:5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br><span class="line">    virtual-host: &#x2F;</span><br><span class="line">    connection-timeout: 15000</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual    # 手工签收</span><br><span class="line">        concurrency: 5</span><br><span class="line">        max-concurrency: 10</span><br></pre></td></tr></table></figure>
<ul>
<li>第三步：RabbitRecever消费端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.consumer;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line">import org.springframework.amqp.rabbit.annotation.*;</span><br><span class="line">import org.springframework.amqp.support.AmqpHeaders;</span><br><span class="line">import org.springframework.messaging.Message;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class RabbitMQReceiver &#123;</span><br><span class="line"></span><br><span class="line">    @RabbitListener(bindings &#x3D; @QueueBinding(</span><br><span class="line">            value &#x3D; @Queue(value &#x3D; &quot;queue-1&quot;,</span><br><span class="line">                           durable&#x3D;&quot;true&quot;),</span><br><span class="line">            exchange &#x3D; @Exchange(value &#x3D; &quot;exchange-1&quot;,</span><br><span class="line">                                 durable&#x3D;&quot;true&quot;,</span><br><span class="line">                                 type&#x3D; &quot;topic&quot;,</span><br><span class="line">                                 ignoreDeclarationExceptions &#x3D; &quot;true&quot;),</span><br><span class="line">            key &#x3D; &quot;springboot.*&quot;</span><br><span class="line">            )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    @RabbitHandler</span><br><span class="line">    public void onMessage(Message message, Channel channel) throws Exception &#123;</span><br><span class="line">        System.err.println(&quot;--------------------------------------&quot;);</span><br><span class="line">        System.err.println(&quot;消费端Payload: &quot; + message.getPayload());</span><br><span class="line">        Long deliveryTag &#x3D; (Long)message.getHeaders().get(AmqpHeaders.DELIVERY_TAG);</span><br><span class="line">        &#x2F;&#x2F;手工ACK</span><br><span class="line">        channel.basicAck(deliveryTag, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>生产端测试：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.rabbitmq.test;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.producer.RabbitMQSender;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ApplicationTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RabbitMQSender rabbitMQSender;</span><br><span class="line"></span><br><span class="line">    private static SimpleDateFormat simpleDateFormat &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testSender() throws Exception &#123;</span><br><span class="line">        Map&lt;String, Object&gt; properties &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        properties.put(&quot;number&quot;, &quot;12345&quot;);</span><br><span class="line">        properties.put(&quot;send_time&quot;, simpleDateFormat.format(new Date()));</span><br><span class="line">        rabbitMQSender.send(&quot;Hello RabbitMQ For SpringBoot!&quot;, properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码地址 <a target="_blank" rel="noopener" href="https://github.com/dupeihui/rabbitmq-springboot">https://github.com/dupeihui/rabbitmq-springboot</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/" class="post-title-link" itemprop="url">RabbitMQ中的Confirm确认与Return返回消息</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-17 18:40:25" itemprop="dateCreated datePublished" datetime="2021-02-17T18:40:25+08:00">2021-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:20:57" itemprop="dateModified" datetime="2021-02-21T23:20:57+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Confirm消息确认机制：</strong>  </p>
<ul>
<li>消息的确认是指生产者投递消息后，如果Broker收到消息，则会给我们生产者一个应答。  </li>
<li>生产者进行接受应答，用来确认这条消息是否正常的发送到Broker，这种方式也是消息的可靠性投递的核心保障。</li>
</ul>
<img src="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/confirm.png" class="">

<p><strong>如何实现Confirm确认消息？</strong>  </p>
<ul>
<li>第一步：在channel上开启确认模式：channel.confirmSelect()</li>
<li>第二步：在channel上添加监听：addConfirmListener，监听成功和失败的返回结果，根据具体的结果对消息进行重新发送、或者记录日志等后续处理。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;生产端代码</span><br><span class="line">        &#x2F;&#x2F;1 创建ConnectionFactory</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;2 获取C    onnection</span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;3 通过Connection创建一个新的Channel</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;4 指定我们的消息投递模式: 消息的确认模式</span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_confirm_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;confirm.save&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;5 发送一条消息</span><br><span class="line">        String msg &#x3D; &quot;Hello RabbitMQ Send confirm message!&quot;;</span><br><span class="line">        channel.basicPublish(exchangeName, routingKey, null, msg.getBytes());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;6 添加一个确认监听</span><br><span class="line">        channel.addConfirmListener(new ConfirmListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void handleNack(long deliveryTag, boolean multiple) throws IOException &#123;</span><br><span class="line">                System.err.println(&quot;-------no ack!-----------&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void handleAck(long deliveryTag, boolean multiple) throws IOException &#123;</span><br><span class="line">                System.err.println(&quot;-------ack!-----------&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;消费端代码</span><br><span class="line">        &#x2F;&#x2F;1 创建ConnectionFactory</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;2 获取C    onnection</span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;3 通过Connection创建一个新的Channel</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_confirm_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;confirm.#&quot;;</span><br><span class="line">        String queueName &#x3D; &quot;test_confirm_queue&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;4 声明交换机和队列 然后进行绑定设置, 最后制定路由Key</span><br><span class="line">        channel.exchangeDeclare(exchangeName, &quot;topic&quot;, true);</span><br><span class="line">        channel.queueDeclare(queueName, true, false, false, null);</span><br><span class="line">        channel.queueBind(queueName, exchangeName, routingKey);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;5 创建消费者</span><br><span class="line">        QueueingConsumer queueingConsumer &#x3D; new QueueingConsumer(channel);</span><br><span class="line">        channel.basicConsume(queueName, true, queueingConsumer);</span><br><span class="line"></span><br><span class="line">        while(true)&#123;</span><br><span class="line">            Delivery delivery &#x3D; queueingConsumer.nextDelivery();</span><br><span class="line">            String msg &#x3D; new String(delivery.getBody());</span><br><span class="line"></span><br><span class="line">            System.err.println(&quot;消费端: &quot; + msg);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><strong>Return消息返回机制：</strong>  </p>
<ul>
<li><p>Return Listener用于处理一些不可路由的消息。</p>
</li>
<li><p>我们的消息生产者，通过指定一个Exchange和Routingkey，把消息送到某一个队列中，然后我们的消费者监听队列，进行消息处理操作。但是在某些情况下，如果我们在发送消息的时候，当前的exchange不存在或者指定的路由key路由不到，这个时候我们需要监听这种不可达的消息，就要使用return listener。  </p>
<p><strong>在基础API中有一个关键的配置项：</strong><br><strong>mandatory：</strong> 如果为true，则监听会接收到路由不可达的消息，然后进行后续处理，如果为false，那么broker端自动删除该消息。（默认false）</p>
</li>
</ul>
<img src="/2021/02/17/RabbitMQ%E4%B8%AD%E7%9A%84Confirm%E7%A1%AE%E8%AE%A4%E4%B8%8EReturn%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF/return.png" class="">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;生产端代码</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchange &#x3D; &quot;test_return_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;return.save&quot;;</span><br><span class="line">        String routingKeyError &#x3D; &quot;abc.save&quot;;</span><br><span class="line"></span><br><span class="line">        String msg &#x3D; &quot;Hello RabbitMQ Return Message&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.addReturnListener(new ReturnListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void handleReturn(int replyCode, String replyText, String exchange,</span><br><span class="line">                    String routingKey, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.err.println(&quot;---------handle  return----------&quot;);</span><br><span class="line">                System.err.println(&quot;replyCode: &quot; + replyCode);</span><br><span class="line">                System.err.println(&quot;replyText: &quot; + replyText);</span><br><span class="line">                System.err.println(&quot;exchange: &quot; + exchange);</span><br><span class="line">                System.err.println(&quot;routingKey: &quot; + routingKey);</span><br><span class="line">                System.err.println(&quot;properties: &quot; + properties);</span><br><span class="line">                System.err.println(&quot;body: &quot; + new String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.basicPublish(exchange, routingKeyError, true, null, msg.getBytes());</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;消费端代码</span><br><span class="line">        ConnectionFactory connectionFactory &#x3D; new ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(&quot;127.0.0.1&quot;);</span><br><span class="line">        connectionFactory.setPort(5672);</span><br><span class="line">        connectionFactory.setVirtualHost(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">        Connection connection &#x3D; connectionFactory.newConnection();</span><br><span class="line">        Channel channel &#x3D; connection.createChannel();</span><br><span class="line"></span><br><span class="line">        String exchangeName &#x3D; &quot;test_return_exchange&quot;;</span><br><span class="line">        String routingKey &#x3D; &quot;return.#&quot;;</span><br><span class="line">        String queueName &#x3D; &quot;test_return_queue&quot;;</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(exchangeName, &quot;topic&quot;, true, false, null);</span><br><span class="line">        channel.queueDeclare(queueName, true, false, false, null);</span><br><span class="line">        channel.queueBind(queueName, exchangeName, routingKey);</span><br><span class="line"></span><br><span class="line">        QueueingConsumer queueingConsumer &#x3D; new QueueingConsumer(channel);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queueName, true, queueingConsumer);</span><br><span class="line"></span><br><span class="line">        while(true)&#123;</span><br><span class="line"></span><br><span class="line">            Delivery delivery &#x3D; queueingConsumer.nextDelivery();</span><br><span class="line">            String msg &#x3D; new String(delivery.getBody());</span><br><span class="line">            System.err.println(&quot;消费者: &quot; + msg);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">RabbitMQ入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-13 23:07:05" itemprop="dateCreated datePublished" datetime="2021-02-13T23:07:05+08:00">2021-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-21 23:12:47" itemprop="dateModified" datetime="2021-02-21T23:12:47+08:00">2021-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">分布式架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是RabbitMQ-？"><a href="#什么是RabbitMQ-？" class="headerlink" title="什么是RabbitMQ ？"></a>什么是RabbitMQ ？</h2><p>RabbitMQ是一个开源的消息代理和队列服务器，用来通过普通协议在完全不同的应用之间共享数据，RabbitMQ是使用Erlang语言编写的，并且RabbitMQ是基于AMQP协议的。  </p>
<h2 id="什么是AMQP高级消息队列协议-？"><a href="#什么是AMQP高级消息队列协议-？" class="headerlink" title="什么是AMQP高级消息队列协议 ？"></a>什么是AMQP高级消息队列协议 ？</h2><p>AMQP：Advanced Message Queuing Protocol.<br>AMQP定义：是具有现代特征的二进制协议。是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。  </p>
<p><strong>AMQP协议模型</strong>  </p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/AMQP.png" class="">

<p><strong>Server</strong> : 又称Broker，接受客户端的连接，实现AMQP实体服务。<br><strong>Connection</strong> : 连接，应用程序与Broker的网络连接。<br><strong>Channel</strong> : 网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道。客户端可建立多个Channel，每个Channel代表一个会话任务。<br><strong>Message</strong> : 消息，服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容。<br><strong>Virtual host</strong> : 虚拟地址，用于进行逻辑隔离，最上层的消息路由。一个Virtual Host里面可以有若干个Exchange和Queue，同一个VirtualHost 里面不能有相同名称的Exchange或Queue。<br><strong>Exchange</strong> : 交换机，接收消息，根据路由键转发消息到绑定的队列。<br><strong>Binding</strong> :  Exchange和Queue之间的虚拟连接，binding中可以包含routing key。<br><strong>Routing key</strong> : 一个路由规则，虚拟机可用它来确定如何路由一个特定消息。<br><strong>Queue</strong> : 也称为Message Queue,消息队列，保存消息并将它们转发给消费者。</p>
<p><strong>RabbitMQ整体架构</strong></p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/RabbitMQ-arch.png" class="">

<h2 id="RabbitMQ核心API"><a href="#RabbitMQ核心API" class="headerlink" title="RabbitMQ核心API"></a>RabbitMQ核心API</h2><p><strong>核心API - Exchange概念</strong><br>Exchange ： 接受消息，并根据路由键转发消息到所绑定的队列。这是RabbitMQ非常重要的概念。  </p>
<ul>
<li><p>Exchange（交换机）本身有很多属性和类型 ：  </p>
</li>
<li><p>Exchange属性 ：  </p>
<ul>
<li>Type ： 交换机类型 direct、topic、fanout、headers</li>
<li>Durability ： 是否需要持久化，默认为true表示持久化</li>
<li>Auto Delete ： 当最后一个绑定到Exchange上的队列删除后，自动删除该Exchange</li>
<li>Internal ： 当前Exchange是否用于RabbitMQ内部使用，默认为False</li>
<li>Arguments ： 扩展参数，用于扩展AMQP协议自制定化使用</li>
</ul>
</li>
<li><p>交换机类型 ：  </p>
<ul>
<li><p>Direct Exchange : 所有发送到Direct Exchange的消息被转发到RouteKey中指定的Queue，如下图所示：</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/direct.png" class="">
</li>
<li><p>Topic Exchange ： 所有发送到Topic Exchange的消息被转发到所有关心RouteKey中指定Topic的Queue上。Exchange将RouteKey和某Topic进行模糊匹配，此时队列需要绑定一个Topic。符号“#”：匹配一个或多个词，例如“Log.#”能够匹配到”log.info.abc”；符号”<em>“：只匹配一个词，例如”log.</em>“只会匹配到”log.error”。如下图所示：</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/topic.png" class="">
</li>
<li><p>Fanout Exchange ： 不处理路由键，只需要简单的将队列绑定到交换机上。发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。Fanout交换机转发消息是最快的，它不会做各种路由匹配。</p>
<img src="/2021/02/13/RabbitMQ%E5%85%A5%E9%97%A8/fanout.png" class="">
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/01/redis%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/01/redis%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">redis哨兵机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-01 13:21:40" itemprop="dateCreated datePublished" datetime="2021-01-01T13:21:40+08:00">2021-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:49" itemprop="dateModified" datetime="2021-02-23T21:22:49+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>Redis Sentinel为Redis提供了高可用，这意味着使用Sentinel可以创建部署，该部署可以在无需人工干预的情况下抵抗某些类型的故障，如主从模式下master节点服务器宕机。<br>Redis Sentinel还提供了附带任务，如：监控、通知、为客户端充当配置提供者。<br>这是宏观上Sentinel功能的完整列表：  </p>
<ul>
<li>监控：Sentinel会不断的检查主实例和从实例是否按预期工作。</li>
<li>通知：Sentinel可以通过API通知系统管理员或其他计算机程序，其中一个受监控的Redis实例出了问题。</li>
<li>自动故障转移：如果主服务未按预期工作，则Sentinel可以启动故障转移过程，在该过程中将其中一个从服务升级为主服务，其他从服务重新配置新主服务的地址，使用Redis服务的应用程序在连接时被通知使用新主服务的地址。  </li>
<li>配置提供者：Sentinel充当客户端服务发现的授权来源：客户端连接到Sentinels，以询问负责给定服务的当前Redis主服务的地址。如果发生故障转移，Sentinel将报告新地址。</li>
</ul>
<h2 id="Sentinel配置"><a href="#Sentinel配置" class="headerlink" title="Sentinel配置"></a>Sentinel配置</h2><p>Redis源发行版包含一个名为sentinel.conf的文件，该文件是一个自说明性的示例配置文件，可用于配置Sentinel，但是典型的最小配置文件如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># sentinel monitor &lt;master-group-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</span><br><span class="line"># sentinel监控一个名为mymaster的主服务器，该主服务器地址和端口为127.0.0.1和6379，quorum为触发客观下线的数量</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"># master最长响应时间，超过这个时间就主观判断它下线，默认60秒</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line"></span><br><span class="line"># 执行故障转移的最大等待时间，默认3分钟</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"># 用于限制主从切换之后，最多的并行同步数据的从节点数量</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></table></figure>
<h2 id="运行Sentinel"><a href="#运行Sentinel" class="headerlink" title="运行Sentinel"></a>运行Sentinel</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel &#x2F;path&#x2F;to&#x2F;sentinel.conf</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PD">
      <meta itemprop="description" content="Cream rises to the top.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">redis主从架构模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-29 23:36:34" itemprop="dateCreated datePublished" datetime="2020-12-29T23:36:34+08:00">2020-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 21:22:54" itemprop="dateModified" datetime="2021-02-23T21:22:54+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">集群架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>单机的redis，能够承载的QPS大概在上万到几万不等。对于缓存来说，一般都是用来支撑读高并发。因此架构做成主从（master-slave）架构，一主多从，主负责写，并且将数据复制到其他的slave节点，从节点负责读。所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑读高并发。</p>
<h2 id="redis主从复制的核心原理"><a href="#redis主从复制的核心原理" class="headerlink" title="redis主从复制的核心原理"></a>redis主从复制的核心原理</h2><p>当启动一个slave node的时候，它会发送一个PSYNC命令给master node。<br>如果这是 slave node 初次连接到 master node，那么会触发一次 full resynchronization 全量复制。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后， master 会将这个 RDB 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。  </p>
<img src="/2020/12/29/redis%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/redis-master-slave.png" class="">

<h2 id="redis配置主从架构"><a href="#redis配置主从架构" class="headerlink" title="redis配置主从架构"></a>redis配置主从架构</h2><p>进入从节点，打开redis配置文件，进行如下配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 配置所属主服务器ip和端口</span><br><span class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">replicaof 192.168.1.1 6379</span><br><span class="line"></span><br><span class="line"># 配置所属主服务器的密码</span><br><span class="line"># masterauth &lt;master-passord&gt;</span><br><span class="line">masterauth 123456</span><br><span class="line"></span><br><span class="line"># 从服务器通常是只读，配置只读</span><br><span class="line">replica-read-only yes</span><br><span class="line"></span><br><span class="line"># 主从复制同步策略：disk or socket，无磁盘化复制</span><br><span class="line">repl-diskless-sync no</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">PD</p>
  <div class="site-description" itemprop="description">Cream rises to the top.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PD</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
